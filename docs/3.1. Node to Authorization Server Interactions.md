# Node to Authorization Server Interactions  
_(c) AMWA 2021, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_
## Overview
This section details the interactions between the NMOS Node and the Authorization Server. These include:

 - **Discovery of the Authorization Server**
 - **Client Registration**: Registration of the NMOS Node with the Authorization Server.
 - **Client Credentials Flow**: Request of an Access Token from the Authorization Server.
 - **Refreshing the Bearer Token**: Ensuring the token is always valid 
- **Fetch Authorization Server Public Keys**: To authenticate Access Tokens in incoming API calls.

![Node to Authorization Interactions](./images/client_credentials_flow.png)

The sequence diagram above gives an overview of these interaction which are described in more detail below.
## Discovery of the Authorization Server
In order to interact with the Authorization Server, you need to know where it is.  IS-10 specifies that the [Authorization Server should use unicast DNS-SD](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#dns-sd-advertisemen) to advertise itself to the  Node.

Once the node knows the whereabouts of the Authorization Server it can then fetch the [Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata HTTP response:

	HTTP/1.1 200 OK
	Content-Type: application/json

```
{
    "issuer": "https://authorization-server.com",
    "authorization_endpoint": "authorization-server.com/authorize",
    "token_endpoint": "https://authorization-server.com/token",
    "token_introspection_endpoint": "https://authorization-server.com/introspect",
	"userinfo_endpoint": "https://authorization-server.com/userinfo",
	"end_session_endpoint": "https://authorization-server.com/logout",
	"jwks_uri": "https://authorization-server.com/jwks",	  
	"grant_types_supported": [
	   "authorization_code",
	   "implicit",
	   "refresh_token",
	   "password",
	   "client_credentials"
	],
	"response_types_supported": [
	   "code",
	   "none",
	   "id_token",
	   "token",
	   "id_token token",
	   "code id_token",
	   "code token",
	   "code id_token token"
	],	  
	"scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
    ],
    "code_challenge_methods_supported": [
        "plain",
        "S256"
	]
}
```
## Client Registration 
NMOS nodes first needs to register with the Authorization Server.  This is usually a one time operation that a Node would typically perform when first activated on the network.

The registration is done via a [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration) with the Authorization Server. The registration includes the expected grant type, which should be set to  [client credentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials)

Depending on how the Authorization Server has been configured, it is likely that the Client Registration will need to be authenticated using an Initial Access Token.  This token will be generated by the Authentication Server, and provided to the NMOS Node by some proprietary method. 

Example client registration request including an Initial Access Token (This is the `Authorization: Bearer` in the HTTP header):

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
```    
{
    "client_name": "My Example Client",
    "grant_types": ["client_credentials"],
    "jwks_uri": "https://client.example.org/my_public_keys.jwks",
    "response_types": ["none"],
    "scope": "registration",
    "token_endpoint_auth_method": "private_key_jwt"
}
```
Example response:

    HTTP/1.1 201 Created
    Content-Type: application/json
```    	
{
    "client_id": "xxxxxxxxxx",
    "client_name": "My Example Client",
    "client_id_issued_at": 1611940142,
    "grant_types": ["client_credentials"],
    "jwks_uri": "https://client.example.org/my_public_keys.jwks",
    "response_types": [],
    "token_endpoint_auth_method": "private_key_jwt"
}
```
## Client Credentials Flow
The Node can now request a bearer token from the Authorization Server using the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response). This access token will allow the Node to authenticate API calls on other NMOS Nodes, for instance, the NMOS Registry.

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

In this request the `client_assertion` is a self signed JWT and `client_id` is the result from client registration.

Example token response:

	HTTP/1.1 200 OK
	Content-Type: application/json
	
	{
	 "access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
	 "expires_in":180,
	 "scope":"registration",
	 "token_type":"bearer"
	}

## Refreshing the Bearer Token
The Bearer Token has a limited life specified in seconds by the value of the `expires_in` parameter.  The Node should refresh the token before [it exceeds its half life](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime) (if the token lifetime is 30 seconds, then it should be refreshed at least 15 seconds before token expiry). 

Unlike the Authorization Code Flow, the Client Credential Flow does not issue a refresh token 'refreshing' the token simply involves repeating the Client Credential Flow.

## Fetch Authorization Server Public Keys
As well as acquiring a token to allow this Node to register, the Node will also need the [Authorization Server's public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) so that it can authenticate calls on its own APIs.  These keys should be fetched every hour to ensure the keys are always up to date.

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
Example server public keys response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	[
	 {
	  "alg":"RS256",
	  "e":"AQAB",
	  "kid":"aRxkfaepyicuogJnoaXfUJAEDwiDQ3o914n2JNqToZ0",
	  "kty":"RSA",
	  "n":"jBRq3QfleVgYxjS3q-tmK8686Pc2HvR50kxfB6l...",
	  "use":"sig",
	  "x5c":["MIICmzCCAYMCBgFxiHgcuzANBgkqhkiG9w0BAQ..."],
	  "x5t":"qaEz9PpliodKhNXA5jqiUky5-RU",
	  "x5t#S256":"hfJS5jB9chso-iMQ7-QNAIXFPFwz6SjrohG81r6IxyE"
	 },
	 {
	  "alg":"ES256",
	  "crv":"P-256",
	  "kid":"jMRpEWZ8_-1pmdpGqEo4ZSCb7pltOVuoQQc46aYa7RM",
	  "kty":"EC",
	  "use":"sig",
	  "x":"e7DQRay3ZWCj-Y_-Ww-QN-m95KV2IBVpZ2raP3CF5XU",
	  "y":"ay2UR1ohsrWhJgsv8T0cV66yivD4kA9_3YV8RJFjD3k"
	 },
	 {
	  "alg":"RS512",
	  "e":"AQAB",
	  "kid":"O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
	  "kty":"RSA",
	  "n":"yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkmTYa...",
	  "use":"sig",
	  "x5c":["MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAw..."],
	  "x5t":"LD3awp-sYoVbcfwOgB9BRO4HFYQ",
	  "x5t#S256":"yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
	 }
	]

Note that if a Node is unable to contact an Authorization Server, it should attempt to contact another Authorization Server from the discovered list until this [either succeeds or the list is exhausted](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys). 
<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJKZTVCdHRuMm9zcFNCcW9uIjp7In
N0YXJ0IjoxNjUxLCJlbmQiOjI2MTMsInRleHQiOiJ7XG5cdCBc
Imlzc3VlclwiOiBcImh0dHBzOi8vYXV0aG9yaXphdGlvbi1zZX
J2ZXIuY29tXCIsXG5cdCBcImF1dGhvcml6YXRpb25fZW5kcG9p
bnRcIjogXCLigKYifX0sImNvbW1lbnRzIjp7InZoOUVhNG1VUX
h1WXp1R0MiOnsiZGlzY3Vzc2lvbklkIjoiSmU1QnR0bjJvc3BT
QnFvbiIsInN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6InB1bG
wgdGhlc2Ugb3V0IGludG8gZXhhbXBsZSBmaWxlcyIsImNyZWF0
ZWQiOjE2MTI5NTc0MDIyMzZ9fSwiaGlzdG9yeSI6Wzk2OTAzNj
IxN119
-->