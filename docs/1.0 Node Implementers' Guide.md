# NMOS Authorization: Node  Implementation Guide
_(c) AMWA 2020, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_

## Document Scope
This document is intended as a guide for Implementers of NMOS Nodes to include NMOS Authorization 

IS-10 is based on the OAuth2 recommendation, it is used for protecting the NMOS APIs, which allowing NMOS Node and NMOS Registry to give the limited access for the third party application. Third application including Broadcast Controller System, which queries NMOS Registry via IS-04 for all the registered Nodes information and making IS-05 Node connections. NMOS Nodes are also acted as the third party for the NMOS Registry to perform IS-04 node registration.  In this document, we are focused on the NMOS Node implementation.
    
## Pre-requisites

  You should be familiar the following specification and technologies before beginning 
  
### NMOS IS-04, IS-05, IS-08

[IS-04](https://specs.amwa.tv/is-04/)
[IS-05](https://specs.amwa.tv/is-05/)
[IS-08](https://specs.amwa.tv/is-08/)
[IS-10](https://specs.amwa.tv/is-10/)
  
### OAuth 2.0
Client Credentials Flow  

MF: One useful set of articles is a 4 part series that appears to be on several sites. The links to the first 3 parts on one site are:  
[Part 1](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st "https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st")
[Part 2](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-2-oauth20)
[Part 3](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-3-jwt)
The 4th part is mainly a specific code example in Java, so doesn't seem as relevant

### JavaScript Web Tokens (JWT)
[Links to resources/specifications]
[debugger-io](https://jwt.io/#debugger-io)  seems to be a useful link for experimenting with building and decoding JWTs  
  
## Authenticated API Calls

### Node to Authentication Server Interactions  

![Client Credential Flow](./diagrams/client_credentials_flow.png)

1. Node [discoveries Authorization Server](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discove	ry.html#dns-sd-advertisement) via unicast DNS-SD.
2. Node [fetches Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	{
	  "issuer": "https://authorization-server.com",
	  "authorization_endpoint": "authorization-server.com/authorize",
	  "token_endpoint": "https://authorization-server.com/token",
	  "token_introspection_endpoint": "https://authorization-server.com/introspect",
	  "userinfo_endpoint": "https://authorization-server.com/userinfo",
	  "end_session_endpoint": "https://authorization-server.com/logout",
	  "jwks_uri": "https://authorization-server.com/jwks",	  
	  "grant_types_supported": [
	    "authorization_code",
	    "implicit",
	    "refresh_token",
	    "password",
	    "client_credentials"
	  ],
	  "response_types_supported": [
	    "code",
	    "none",
	    "id_token",
	    "token",
	    "id_token token",
	    "code id_token",
	    "code token",
	    "code id_token token"
	  ],
	  "id_token_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "registration_endpoint": "https://authorization-server.com/register",
	  "token_endpoint_auth_methods_supported": [
	    "private_key_jwt",
	    "client_secret_basic",
	    "client_secret_post",
	    "tls_client_auth",
	    "client_secret_jwt"
	  ],
	  "token_endpoint_auth_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
	  ],
	  "code_challenge_methods_supported": [
	    "plain",
	    "S256"
	  ]
	}

3. If Node has not yet registered to the Authorization Server (it can be verified by fetching the client metadata using the registration_access_token on the registration_client_uri which were given while executing the client registration), use [client crendentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials) to perform [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration).

Example client registration request including initial access token:

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
    
	{
	 "client_name": "My Example Client",
	 "grant_types": ["client_credentials"],
	 "jwks_uri": "https://client.example.org/my_public_keys.jwks",
	 "response_types": ["none"],
	 "scope": "registration",
	 "token_endpoint_auth_method": "private_key_jwt"
	}

Example response:

    HTTP/1.1 201 Created
    Content-Type: application/json
    	
    {
     "client_id": "xxxxxxxxxx",
     "client_name":"My Example Client",
     "grant_types":["client_credentials"],
     "jwks_uri":"https://client.example.org/my_public_keys.jwks",
     "redirect_uris":[],
     "registration_access_token":"eyJhbGciOiJIUzI1NiIsInR5c...",
     "registration_client_uri":"https://authorization-server.com/xxxxxxxxxx",
     "response_types":[],
     "token_endpoint_auth_method":"private_key_jwt"
     }

4. Node starts the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response) to fetch bearer token.

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

where client_assertion is a self signed JWT and client_id is the result from client registration.

Example token response:

	HTTP/1.1 200 OK
	Content-Type: application/json
	
	{
	 "access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
	 "expires_in":180,
	 "scope":"registration",
	 "token_type":"bearer"
	}

5. Node refreshes bearer token as in step 4 at least 15 seconds before token expiry (i.e. [half-life of the token](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime)).
6. Node fetches [Authorization Server public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) in every hour for  validating incoming access token.

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
Example server public keys response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	[
	 {
	  "alg":"RS256",
	  "e":"AQAB",
	  "kid":"aRxkfaepyicuogJnoaXfUJAEDwiDQ3o914n2JNqToZ0",
	  "kty":"RSA",
	  "n":"jBRq3QfleVgYxjS3q-tmK8686Pc2HvR50kxfB6l...",
	  "use":"sig",
	  "x5c":["MIICmzCCAYMCBgFxiHgcuzANBgkqhkiG9w0BAQ..."],
	  "x5t":"qaEz9PpliodKhNXA5jqiUky5-RU",
	  "x5t#S256":"hfJS5jB9chso-iMQ7-QNAIXFPFwz6SjrohG81r6IxyE"
	 },
	 {
	  "alg":"ES256",
	  "crv":"P-256",
	  "kid":"jMRpEWZ8_-1pmdpGqEo4ZSCb7pltOVuoQQc46aYa7RM",
	  "kty":"EC",
	  "use":"sig",
	  "x":"e7DQRay3ZWCj-Y_-Ww-QN-m95KV2IBVpZ2raP3CF5XU",
	  "y":"ay2UR1ohsrWhJgsv8T0cV66yivD4kA9_3YV8RJFjD3k"
	 },
	 {
	  "alg":"RS512",
	  "e":"AQAB",
	  "kid":"O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
	  "kty":"RSA",
	  "n":"yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkmTYa...",
	  "use":"sig",
	  "x5c":["MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAw..."],
	  "x5t":"LD3awp-sYoVbcfwOgB9BRO4HFYQ",
	  "x5t#S256":"yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
	 }
	]

7. Node switches to next available Authorization Server, if it's unable to commuincate with the connected Authorization Server.
  
### Node to Registry (IS-04 Registration API)  
[ Include Sequence Diagram]
MF: I think the textual steps are:

1. Node is registered with the authorization server (flow diagram of steps?)  
2. Node sends client credentials (and other information?) to authorization server to get access token 
3. Node sends access token to registry as extra HTTP header with existing registry communications

Example resource registration request:

	POST /resource HTTP/1.1
    Host: registry.example.org
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...
    
    {
     "type": "node",
     "data": 
      description:"host1",
      hostname:"host1",
      label:"host1",
      ...
     }
    }

5. Does a description of the registry behaviour on receipt of the access token make sense here, or should that go elsewhere and have a link back to here? I believe it is essentially the same thing as stage 6 of the "controller to node" interaction below.  
6. If I understand correctly, the refresh token does not apply (or doesn't make much sense) in the client credentials grant workflow. So when the access token expires (checking IAT itself, or authorisation failure return from registry), the node just repeats step (2) 
  
### Controller to Node (IS-05, IS-08 and IS-04 Node API)  
[ Include Sequence Diagram]  

_MF: I believe the pattern for accessing all three of these APIs is very similar_

MF: I think the textual steps are:
1) Controller is registered with the authorisation server (does that apply, as I think it counts as a "public client"?)
2) Controller user gets redirected to authorisation server on login, to authenticate with authorisation server
3) Authorisation server returns redirect to client browser(?) as part of the authorisation code grant
4) Client (presumably part of the controller, not the user's browser) obtains access token from authorisation server for access to NMOS node resources (what extra information does it need to send?)
5) Controller sends access token to Node as part of HTTP headers on access to resources
6) Node has to verify the access token:
6a) Verify the signature of the token. This requires obtaining the public key from the authorisation server, and then applying a "RSASSA-PKCS1-v1_5 using SHA-512" check on the signature in the token
6b) Verify the fields of the token are correct, including expiry time, iat/nbf (IS-10 doesn't mention nbf, but other JWT texts do), aud and iss, plus x-nmos-* claims.
7) If stage 6 passes, then return the requested data, otherwise return an authorisation failure HTTP code.

_PB: as required, further guidance on spec details e.g. the NBF field question_  

### Event & Tally (IS-07)
[ Include Sequence Diagram]  
_MF: I believe the pattern for this API is different, as it can include node-to-node communication, and is mainly based around websockets or MQTT, rather than traditional HTTP requests_

## Implementation resources 
### Authentication Server
[An auth server is required - link to open source implementations such as Keycloak]
_MF: Guidance on how to set it up for this. See AB wiki guide plus how to segment network. AB: maybe BBC could provide container with config, helped with docker-compose._  
  
### NMOS Testing Tool
[Description and links to the NMOS Testing tool]  
  
### VPN-based testing and virtual workshops
_[Question Only available to AMWA members, so probably best excluded from this guide?]_

_PB: yes, but could reference how we did this (TE blog post++)_

## References
-   external OAuth 2.0 and JWT tutorials
-   Sony slides (updated)
-   not-as-yet-written IS-04/05/08 implementers' guides
-   Existing wiki implementers info
-   Initial white papers from BBC










<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJpeVREbld2VTN4ckFiQkoyIjp7In
RleHQiOiIxLiBOb2RlIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUg
YXV0aG9yaXphdGlvbiBzZXJ2ZXIgKGZsb3cgZGlhZ3JhbSBvZi
BzdGVwcz8p4oCmIiwic3RhcnQiOjg0ODQsImVuZCI6ODY2NH0s
InV6S1Vnc3BremRCdnE4UEoiOnsidGV4dCI6IjEpIENvbnRyb2
xsZXIgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBhdXRob3Jpc2F0
aW9uIHNlcnZlciAoZG9lcyB0aGF0IGFwcGx5LCBhc+KApiIsIn
N0YXJ0Ijo5ODM5LCJlbmQiOjk5NTh9LCJSRGpNdnZuc1YxTkVl
N05VIjp7InRleHQiOiI1LiBJZiBJIHVuZGVyc3RhbmQgY29ycm
VjdGx5LCB0aGUgcmVmcmVzaCB0b2tlbiBkb2VzIG5vdCBhcHBs
eSAob3IgZG9lc24ndCBtYWtl4oCmIiwic3RhcnQiOjkzNjAsIm
VuZCI6OTYyNn0sImJjVlJwdnEwclZmNThteU0iOnsic3RhcnQi
OjEzMiwiZW5kIjoxNDYsInRleHQiOiJEb2N1bWVudCBTY29wZS
J9LCJVak5CMGV1Wk5YOTFWSkZyIjp7InN0YXJ0Ijo3ODUsImVu
ZCI6Nzk5LCJ0ZXh0IjoiUHJlLXJlcXVpc2l0ZXMifSwiQjJacn
piY2dNOFRVbkhuQSI6eyJzdGFydCI6MTA5MSwiZW5kIjoxMTE0
LCJ0ZXh0IjoiQ2xpZW50IENyZWRlbnRpYWxzIEZsb3cifSwiWH
ZwOUJOZmFsODhnWUtNMCI6eyJzdGFydCI6MTg2MiwiZW5kIjox
ODg1LCJ0ZXh0IjoiQXV0aGVudGljYXRlZCBBUEkgQ2FsbHMifS
wielMzTVpmcFVxaWtGeGdDMCI6eyJzdGFydCI6MTg5MSwiZW5k
IjoxOTMzLCJ0ZXh0IjoiTm9kZSB0byBBdXRoZW50aWNhdGlvbi
BTZXJ2ZXIgSW50ZXJhY3Rpb25zIn0sIk5hbFh1ZGRzVkEwNE1Z
UFAiOnsic3RhcnQiOjExMDU5LCJlbmQiOjExMDgwLCJ0ZXh0Ij
oiRXZlbnQgJiBUYWxseSAoSVMtMDcpIn0sIkphUUZadnFraWpu
bmlQc1EiOnsic3RhcnQiOjExMzAxLCJlbmQiOjExMzI1LCJ0ZX
h0IjoiSW1wbGVtZW50YXRpb24gcmVzb3VyY2VzIn19LCJjb21t
ZW50cyI6eyJkS0l5ZWdlZ29rZ2lQZU9GIjp7ImRpc2N1c3Npb2
5JZCI6Iml5VERuV3ZVM3hyQWJCSjIiLCJzdWIiOiJnaDozMDIz
MTMyMSIsInRleHQiOiJkZXNjcmliZWQgaW4gc3RlcCAzIGFuZC
A0IG9mIE5vZGUgdG8gQXV0aGVudGljYXRpb24gU2VydmVyIElu
dGVyYWN0aW9ucyIsImNyZWF0ZWQiOjE2MTIzOTg1MjE0MDh9LC
JrcDVRQ2F1RjRmd2JHWWJsIjp7ImRpc2N1c3Npb25JZCI6InV6
S1Vnc3BremRCdnE4UEoiLCJzdWIiOiJnaDozMDIzMTMyMSIsIn
RleHQiOiJtYXliZSB0aGlzIGJpdCBzaG91bGQgYmUgZGVzY3Jp
YmVkIGluIGFub3RoZXIgZG9jICBDb250cm9sbGVyIEltcGxlbW
VuYXRlciBHdWlkZSBzZWN0aW9uIENvbnRyb2xsZXIgdG8gQXV0
aGVudGljYXRpb24gU2VydmVyIEludGVyYWN0aW9ucyIsImNyZW
F0ZWQiOjE2MTIzOTg4NTQ0NTl9LCJraFFZcHNydWMzbEhtSEFM
Ijp7ImRpc2N1c3Npb25JZCI6IlJEak12dm5zVjFORWU3TlUiLC
JzdWIiOiJnaDozMDIzMTMyMSIsInRleHQiOiJkZXNjcmliZWQg
aW4gc3RlcCA1IG9mIE5vZGUgdG8gQXV0aGVudGljYXRpb24gU2
VydmVyIEludGVyYWN0aW9ucyIsImNyZWF0ZWQiOjE2MTIzOTg5
MjYxNjh9LCIzUGdKaTZiWXREU1c2ZmY3Ijp7ImRpc2N1c3Npb2
5JZCI6ImJjVlJwdnEwclZmNThteU0iLCJzdWIiOiJnaDo2NDQx
MDExOSIsInRleHQiOiJPdmVydmlldyBpbmNsdWRpbmcgZGVmaW
5pbmcgc2NvcGUgb2YgdGhpcyBndWlkZSBpLmUuIGF1dGhvcml6
YXRpb24gb25seSwgZXhjbHVkaW5nIHRyYW5zcG9ydCBsZXZlbC
BzZWN1cml0eSBvciBjZXJ0aWZpY2F0ZSBwcm92aXNpb25pbmci
LCJjcmVhdGVkIjoxNjEyNDU5NDY3NDU0fSwidDR4UlFiNEdxUX
QyRHgxYSI6eyJkaXNjdXNzaW9uSWQiOiJVak5CMGV1Wk5YOTFW
SkZyIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiUXVlc3
Rpb246IHByZS1yZXF1aXNpdGVzIGNhbiBiZSBzcGxpdCBpbnRv
IGtub3dsZWRnZSByZXF1aXJlZCAoT0F1dGggMi4wLCBKV1QpLC
BhbmQgaW5mcmFzdHJ1Y3R1cmUgcmVxdWlyZWQgZm9yIGltcGxl
bWVudGF0aW9uIChBdXRoIHNlcnZlcikuIFNob3VsZCB0aGVzZS
BiZSBpbiBzZXBhcmF0ZSBzZWN0aW9ucyBvciBwYXJ0IG9mIHRo
ZSBzYW1lPyIsImNyZWF0ZWQiOjE2MTI0NTk0OTE2Mzh9LCJZRj
dVYUJFOEFBQlZycm9EIjp7ImRpc2N1c3Npb25JZCI6IkIyWnJ6
YmNnTThUVW5IbkEiLCJzdWIiOiJnaDo2NDQxMDExOSIsInRleH
QiOiJJbmNsdWRlIGxpbmtzIHRvIHJlc291cmNlcy9zcGVjaWZp
Y2F0aW9ucyIsImNyZWF0ZWQiOjE2MTI0NTk1Mjg2ODh9LCJwcE
gySTNZaUlDb3VlcDE0Ijp7ImRpc2N1c3Npb25JZCI6Ilh2cDlC
TmZhbDg4Z1lLTTAiLCJzdWIiOiJnaDo2NDQxMDExOSIsInRleH
QiOiJEZXNjcmlwdGlvbiBvZiBob3cgdG8gbW9kaWZ5IHRoZSBJ
Uy0wNCwgSVMtMDUgYW5kIElTLTA4IEFQSSBjYWxscyB0byB1c2
UgT0F1dGggMi4wIHRva2VucyIsImNyZWF0ZWQiOjE2MTI0NTk1
NTczMjJ9LCJvUzFBeTBsaVJ4a3ZzZjlBIjp7ImRpc2N1c3Npb2
5JZCI6InpTM01aZnBVcWlrRnhnQzAiLCJzdWIiOiJnaDo2NDQx
MDExOSIsInRleHQiOiJNYXliZSBpbmNsdWRlIHRoaXMgYXMgcG
FydCBvZiB0aGUgTm9kZSB0byBSZWdpc3RyeSBjb21tdW5pY2F0
aW9ucz8iLCJjcmVhdGVkIjoxNjEyNDU5NTc5MDY1fSwiZXRVOG
Z5TjljT0t3cEttQiI6eyJkaXNjdXNzaW9uSWQiOiJOYWxYdWRk
c1ZBMDRNWVBQIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0Ij
oiSXMgdGhpcyBiZXlvbmQgdGhlIHNjb3BlIG9mIHRoaXMgZ3Vp
ZGU/IiwiY3JlYXRlZCI6MTYxMjQ1OTYzMDA2Nn0sIjVvcm5JVl
dDa0J1bkZSOVYiOnsiZGlzY3Vzc2lvbklkIjoiSmFRRlp2cWtp
am5uaVBzUSIsInN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6Ik
JldHRlciBoZWFkaW5nIHRoYW4gdGhpcyAtIHRvbyBhbWJpZ3Vv
dXM/IiwiY3JlYXRlZCI6MTYxMjQ1OTY0ODc1NH19LCJoaXN0b3
J5IjpbLTE1ODI5MzEwMTEsLTExNjk1MjE0MTYsNDY1MzcxNzk5
LC01OTg2Mzk2MTksMTQ2MTQ1MzczMCwxNDM5NzU2NTE2LDE4Nz
gxNTUwMTMsLTg0Mzc5NzQyNCwtMTUwNjQ2Mzg4MSwtNzg4OTk0
NDEsLTE4NTk1OTk1MTEsLTUxNDY5OTc1NiwtODM3MjE4ODUwLD
EyNTM3ODUzMywxODg1NTQwOTI3LC0xNjM2NTI5NzcyLDM3MTMw
MDQzOSwxNjY5MzgzNDkzLDIxMjE5OTI4NzQsLTEwOTkxNzAwXX
0=
-->