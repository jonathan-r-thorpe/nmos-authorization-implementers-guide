# NMOS Authorization: Node  Implementation Guide
_(c) AMWA 2020, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_

## Document Overview
### Scope
This document is intended as a guide for implementers who want to add NMOS Authorization to their NMOS Nodes, where that Node is a typical broadcast device. (Implementation of NMOS Authorization in Nodes that act as controllers is NOT within the scope of this document [REF to NMOS Controller guide]).
### Structure
Pre-requisites - what you need before you start.
Authenticated API Calls - including NMOS Authorization in your Node implementation.
Development Resources - useful tools and resources to help your implementation journey.
References - the guide links to articles, specifications and tutorials. Anything else can be found 

   
## Pre-requisites

Before using this guide, you should be familiar with the following specification and technologies.
  
### NMOS IS-04, IS-05, IS-08
#### [IS-04 Registration & Discovery](https://specs.amwa.tv/is-04/) & [IS-05 Connection Management](https://specs.amwa.tv/is-05/)
As well as a familiarity with the standards, it is also assumed that you already have a working implementation of IS-04 and IS-05 for your NMOS Node.

#### [IS-08 Audio Channel Mapping](https://specs.amwa.tv/is-08/)
If your device has audio capability, then as well as being familiar with the standard, it is assumed that you already have a working implementation of IS-08 for your NMOS Node.
#### [IS-10 Authorization](https://specs.amwa.tv/is-10/) 

The IS-10 Authorization specification is based on OAuth2 and is used for controlling access to IS-04, IS-05 and IS-08 APIs.  This guide will detail implementation of IS-10 in NMOS nodes (excluding controller nodes) for IS-04, IS-05 and IS-08 API calls.
  
### OAuth 2.0
Given that IS-10 is based on OAuth 2.0, a familiarity with the way OAuth 2.0 authentication works, and in particular the Client Credentials Grant flow, is required.  The authentication flows used by IS-10 are the Client Credentials Grant and the Authentication Code Flow. The latter is implemented when the NMOS node is a controller.

The following set of articles give a good grounding in OAuth 2.0.  They are from a four part series; the first three give a good grounding in OAuth 2.0 and JWT independent of implementation language. The fourth article is specific to Java implementations.
[Deep Dive Into OAuth2.0 and JWT (Part 1 Setting the Stage)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st "https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st")
[Deep Dive Into OAuth2.0 and JWT (Part 2 OAuth2.0)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-2-oauth20)
[Deep Dive to OAuth2.0 and JWT (Part 3)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-3-jwt)
[Deep Dive to OAuth2.0 and JWT (Part 4 JWT Use Case)](https://dzone.com/articles/what-is-zuul)

### JavaScript Web Tokens (JWT)
JavaScript Web Tokens is the preferred type of token used in IS-10.  A familiarity with JWT can be gained from the articles linked in the OAuth 2.0 section, or from this [introduction to JWT](https://jwt.io/introduction). 
  
## Authenticated API Calls

### Node to Authentication Server Interactions  
#### Client Registration 
The first step an NMOS node needs to  do is a client registration with the Authentication Server.  This is usually a one time operation that a Node would perform when it was first activated on the network.
![Client Registration](./images/client_registration.png)
##### Yet another level
1. Node [discoveries Authorization Server](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discove	ry.html#dns-sd-advertisement) via unicast DNS-SD.
2. Node [fetches Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	{
	  "issuer": "https://authorization-server.com",
	  "authorization_endpoint": "authorization-server.com/authorize",
	  "token_endpoint": "https://authorization-server.com/token",
	  "token_introspection_endpoint": "https://authorization-server.com/introspect",
	  "userinfo_endpoint": "https://authorization-server.com/userinfo",
	  "end_session_endpoint": "https://authorization-server.com/logout",
	  "jwks_uri": "https://authorization-server.com/jwks",	  
	  "grant_types_supported": [
	    "authorization_code",
	    "implicit",
	    "refresh_token",
	    "password",
	    "client_credentials"
	  ],
	  "response_types_supported": [
	    "code",
	    "none",
	    "id_token",
	    "token",
	    "id_token token",
	    "code id_token",
	    "code token",
	    "code id_token token"
	  ],
	  "id_token_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "registration_endpoint": "https://authorization-server.com/register",
	  "token_endpoint_auth_methods_supported": [
	    "private_key_jwt",
	    "client_secret_basic",
	    "client_secret_post",
	    "tls_client_auth",
	    "client_secret_jwt"
	  ],
	  "token_endpoint_auth_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
	  ],
	  "code_challenge_methods_supported": [
	    "plain",
	    "S256"
	  ]
	}

3. If Node has not yet registered to the Authorization Server (it can be verified by fetching the client metadata using the registration_access_token on the registration_client_uri which were given while executing the client registration), use [client crendentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials) to perform [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration).

Example client registration request including initial access token:

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
    
	{
	 "client_name": "My Example Client",
	 "grant_types": ["client_credentials"],
	 "jwks_uri": "https://client.example.org/my_public_keys.jwks",
	 "response_types": ["none"],
	 "scope": "registration",
	 "token_endpoint_auth_method": "private_key_jwt"
	}

Example response:

    HTTP/1.1 201 Created
    Content-Type: application/json
    	
    {
     "client_id": "xxxxxxxxxx",
     "client_name":"My Example Client",
     "client_id_issued_at": 1611940142,
     "grant_types":["client_credentials"],
     "jwks_uri":"https://client.example.org/my_public_keys.jwks",
     "redirect_uris":[],
     "registration_access_token":"eyJhbGciOiJIUzI1NiIsInR5c...",
     "registration_client_uri":"https://authorization-server.com/xxxxxxxxxx",
     "response_types":[],
     "token_endpoint_auth_method":"private_key_jwt"
     }

4. Node starts the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response) to fetch bearer token.

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

where client_assertion is a self signed JWT and client_id is the result from client registration.

Example token response:

	HTTP/1.1 200 OK
	Content-Type: application/json
	
	{
	 "access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
	 "expires_in":180,
	 "scope":"registration",
	 "token_type":"bearer"
	}

5. Node refreshes bearer token as in step 4 at least 15 seconds before token expiry (i.e. [half-life of the token](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime)).
6. Node fetches [Authorization Server public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) in every hour for  validating incoming access token.

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
Example server public keys response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	[
	 {
	  "alg":"RS256",
	  "e":"AQAB",
	  "kid":"aRxkfaepyicuogJnoaXfUJAEDwiDQ3o914n2JNqToZ0",
	  "kty":"RSA",
	  "n":"jBRq3QfleVgYxjS3q-tmK8686Pc2HvR50kxfB6l...",
	  "use":"sig",
	  "x5c":["MIICmzCCAYMCBgFxiHgcuzANBgkqhkiG9w0BAQ..."],
	  "x5t":"qaEz9PpliodKhNXA5jqiUky5-RU",
	  "x5t#S256":"hfJS5jB9chso-iMQ7-QNAIXFPFwz6SjrohG81r6IxyE"
	 },
	 {
	  "alg":"ES256",
	  "crv":"P-256",
	  "kid":"jMRpEWZ8_-1pmdpGqEo4ZSCb7pltOVuoQQc46aYa7RM",
	  "kty":"EC",
	  "use":"sig",
	  "x":"e7DQRay3ZWCj-Y_-Ww-QN-m95KV2IBVpZ2raP3CF5XU",
	  "y":"ay2UR1ohsrWhJgsv8T0cV66yivD4kA9_3YV8RJFjD3k"
	 },
	 {
	  "alg":"RS512",
	  "e":"AQAB",
	  "kid":"O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
	  "kty":"RSA",
	  "n":"yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkmTYa...",
	  "use":"sig",
	  "x5c":["MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAw..."],
	  "x5t":"LD3awp-sYoVbcfwOgB9BRO4HFYQ",
	  "x5t#S256":"yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
	 }
	]

7. Node switches to next available Authorization Server, if it's unable to commuincate with the connected Authorization Server.
  
### Node to Registry (IS-04 Registration API)  
[ Include Sequence Diagram]
MF: I think the textual steps are:

1. Node is registered with the authorization server (flow diagram of steps?)  
2. Node sends client credentials (and other information?) to authorization server to get access token 
3. Node sends access token to registry as extra HTTP header with existing registry communications

Example resource registration request:

	POST /resource HTTP/1.1
    Host: registry.example.org
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...
    
    {
     "type": "node",
     "data": 
      description:"host1",
      hostname:"host1",
      label:"host1",
      ...
     }
    }

5. Does a description of the registry behaviour on receipt of the access token make sense here, or should that go elsewhere and have a link back to here? I believe it is essentially the same thing as stage 6 of the "controller to node" interaction below.  
6. If I understand correctly, the refresh token does not apply (or doesn't make much sense) in the client credentials grant workflow. So when the access token expires (checking IAT itself, or authorisation failure return from registry), the node just repeats step (2) 
  
### Controller to Node (IS-05, IS-08 and IS-04 Node API)  
[ Include Sequence Diagram]  

_MF: I believe the pattern for accessing all three of these APIs is very similar_

MF: I think the textual steps are:
1) Controller is registered with the authorisation server (does that apply, as I think it counts as a "public client"?)
2) Controller user gets redirected to authorisation server on login, to authenticate with authorisation server
3) Authorisation server returns redirect to client browser(?) as part of the authorisation code grant
4) Client (presumably part of the controller, not the user's browser) obtains access token from authorisation server for access to NMOS node resources (what extra information does it need to send?)
5) Controller sends access token to Node as part of HTTP headers on access to resources
6) Node has to verify the access token:
6a) Verify the signature of the token. This requires obtaining the public key from the authorisation server, and then applying a "RSASSA-PKCS1-v1_5 using SHA-512" check on the signature in the token
6b) Verify the fields of the token are correct, including expiry time, iat/nbf (IS-10 doesn't mention nbf, but other JWT texts do), aud and iss, plus x-nmos-* claims.
7) If stage 6 passes, then return the requested data, otherwise return an authorisation failure HTTP code.

_PB: as required, further guidance on spec details e.g. the NBF field question_  

### Event & Tally (IS-07)
[ Include Sequence Diagram]  
_MF: I believe the pattern for this API is different, as it can include node-to-node communication, and is mainly based around websockets or MQTT, rather than traditional HTTP requests_

## Development Resources 
### Authentication Server
[An auth server is required - link to open source implementations such as Keycloak]
_MF: Guidance on how to set it up for this. See AB wiki guide plus how to segment network. AB: maybe BBC could provide container with config, helped with docker-compose._  
  
### NMOS Testing Tool
[Description and links to the NMOS Testing tool]  
  
### VPN-based testing and virtual workshops
_[Question Only available to AMWA members, so probably best excluded from this guide?]_

_PB: yes, but could reference how we did this (TE blog post++)_
### JavaScript Web Token Tools
This [online tool](https://jwt.io/#debugger-io) is a useful webapp for experimenting with building and decoding JWTs.


## References
-   external OAuth 2.0 and JWT tutorials
-   Sony slides (updated)
-   not-as-yet-written IS-04/05/08 implementers' guides
-   Existing wiki implementers info
-   Initial white papers from BBC










<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJpeVREbld2VTN4ckFiQkoyIjp7In
RleHQiOiIxLiBOb2RlIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUg
YXV0aG9yaXphdGlvbiBzZXJ2ZXIgKGZsb3cgZGlhZ3JhbSBvZi
BzdGVwcz8p4oCmIiwic3RhcnQiOjEwMTA2LCJlbmQiOjEwMjg2
fSwidXpLVWdzcGt6ZEJ2cThQSiI6eyJ0ZXh0IjoiMSkgQ29udH
JvbGxlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGF1dGhvcmlz
YXRpb24gc2VydmVyIChkb2VzIHRoYXQgYXBwbHksIGFz4oCmIi
wic3RhcnQiOjExNDYxLCJlbmQiOjExNTgwfSwiUkRqTXZ2bnNW
MU5FZTdOVSI6eyJ0ZXh0IjoiNS4gSWYgSSB1bmRlcnN0YW5kIG
NvcnJlY3RseSwgdGhlIHJlZnJlc2ggdG9rZW4gZG9lcyBub3Qg
YXBwbHkgKG9yIGRvZXNuJ3QgbWFrZeKApiIsInN0YXJ0IjoxMD
k4MiwiZW5kIjoxMTI0OH0sImJjVlJwdnEwclZmNThteU0iOnsi
dGV4dCI6IkRvY3VtZW50IFNjb3BlIiwic3RhcnQiOjEzMiwiZW
5kIjoxNDF9LCJVak5CMGV1Wk5YOTFWSkZyIjp7InRleHQiOiJQ
cmUtcmVxdWlzaXRlcyIsInN0YXJ0Ijo4MDUsImVuZCI6ODE5fS
wiWHZwOUJOZmFsODhnWUtNMCI6eyJ0ZXh0IjoiQXV0aGVudGlj
YXRlZCBBUEkgQ2FsbHMiLCJzdGFydCI6MzIwNSwiZW5kIjozMj
I4fSwielMzTVpmcFVxaWtGeGdDMCI6eyJ0ZXh0IjoiTm9kZSB0
byBBdXRoZW50aWNhdGlvbiBTZXJ2ZXIgSW50ZXJhY3Rpb25zIi
wic3RhcnQiOjMyMzQsImVuZCI6MzI3Nn0sIk5hbFh1ZGRzVkEw
NE1ZUFAiOnsidGV4dCI6IkV2ZW50ICYgVGFsbHkgKElTLTA3KS
IsInN0YXJ0IjoxMjY4MSwiZW5kIjoxMjcwMn0sImVQZ0dEQXQ4
cHZBZG5lb2YiOnsidGV4dCI6IiMjIyMgW0lTLTA0IFJlZ2lzdH
JhdGlvbiAmIERpc2NvdmVyeV0oaHR0cHM6Ly9zcGVjcy5hbXdh
LnR2L2lzLTA0LykgJiBbSVMtMDUgQ2/igKYiLCJzdGFydCI6OT
UyLCJlbmQiOjEwNTF9fSwiY29tbWVudHMiOnsiZEtJeWVnZWdv
a2dpUGVPRiI6eyJkaXNjdXNzaW9uSWQiOiJpeVREbld2VTN4ck
FiQkoyIiwic3ViIjoiZ2g6MzAyMzEzMjEiLCJ0ZXh0IjoiZGVz
Y3JpYmVkIGluIHN0ZXAgMyBhbmQgNCBvZiBOb2RlIHRvIEF1dG
hlbnRpY2F0aW9uIFNlcnZlciBJbnRlcmFjdGlvbnMiLCJjcmVh
dGVkIjoxNjEyMzk4NTIxNDA4fSwia3A1UUNhdUY0ZndiR1libC
I6eyJkaXNjdXNzaW9uSWQiOiJ1ektVZ3Nwa3pkQnZxOFBKIiwi
c3ViIjoiZ2g6MzAyMzEzMjEiLCJ0ZXh0IjoibWF5YmUgdGhpcy
BiaXQgc2hvdWxkIGJlIGRlc2NyaWJlZCBpbiBhbm90aGVyIGRv
YyAgQ29udHJvbGxlciBJbXBsZW1lbmF0ZXIgR3VpZGUgc2VjdG
lvbiBDb250cm9sbGVyIHRvIEF1dGhlbnRpY2F0aW9uIFNlcnZl
ciBJbnRlcmFjdGlvbnMiLCJjcmVhdGVkIjoxNjEyMzk4ODU0ND
U5fSwia2hRWXBzcnVjM2xIbUhBTCI6eyJkaXNjdXNzaW9uSWQi
OiJSRGpNdnZuc1YxTkVlN05VIiwic3ViIjoiZ2g6MzAyMzEzMj
EiLCJ0ZXh0IjoiZGVzY3JpYmVkIGluIHN0ZXAgNSBvZiBOb2Rl
IHRvIEF1dGhlbnRpY2F0aW9uIFNlcnZlciBJbnRlcmFjdGlvbn
MiLCJjcmVhdGVkIjoxNjEyMzk4OTI2MTY4fSwiM1BnSmk2Yll0
RFNXNmZmNyI6eyJkaXNjdXNzaW9uSWQiOiJiY1ZScHZxMHJWZj
U4bXlNIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiT3Zl
cnZpZXcgaW5jbHVkaW5nIGRlZmluaW5nIHNjb3BlIG9mIHRoaX
MgZ3VpZGUgaS5lLiBhdXRob3JpemF0aW9uIG9ubHksIGV4Y2x1
ZGluZyB0cmFuc3BvcnQgbGV2ZWwgc2VjdXJpdHkgb3IgY2VydG
lmaWNhdGUgcHJvdmlzaW9uaW5nIiwiY3JlYXRlZCI6MTYxMjQ1
OTQ2NzQ1NH0sInQ0eFJRYjRHcVF0MkR4MWEiOnsiZGlzY3Vzc2
lvbklkIjoiVWpOQjBldVpOWDkxVkpGciIsInN1YiI6ImdoOjY0
NDEwMTE5IiwidGV4dCI6IlF1ZXN0aW9uOiBwcmUtcmVxdWlzaX
RlcyBjYW4gYmUgc3BsaXQgaW50byBrbm93bGVkZ2UgcmVxdWly
ZWQgKE9BdXRoIDIuMCwgSldUKSwgYW5kIGluZnJhc3RydWN0dX
JlIHJlcXVpcmVkIGZvciBpbXBsZW1lbnRhdGlvbiAoQXV0aCBz
ZXJ2ZXIpLiBTaG91bGQgdGhlc2UgYmUgaW4gc2VwYXJhdGUgc2
VjdGlvbnMgb3IgcGFydCBvZiB0aGUgc2FtZT8iLCJjcmVhdGVk
IjoxNjEyNDU5NDkxNjM4fSwicHBIMkkzWWlJQ291ZXAxNCI6ey
JkaXNjdXNzaW9uSWQiOiJYdnA5Qk5mYWw4OGdZS00wIiwic3Vi
IjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiRGVzY3JpcHRpb24gb2
YgaG93IHRvIG1vZGlmeSB0aGUgSVMtMDQsIElTLTA1IGFuZCBJ
Uy0wOCBBUEkgY2FsbHMgdG8gdXNlIE9BdXRoIDIuMCB0b2tlbn
MiLCJjcmVhdGVkIjoxNjEyNDU5NTU3MzIyfSwib1MxQXkwbGlS
eGt2c2Y5QSI6eyJkaXNjdXNzaW9uSWQiOiJ6UzNNWmZwVXFpa0
Z4Z0MwIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiTWF5
YmUgaW5jbHVkZSB0aGlzIGFzIHBhcnQgb2YgdGhlIE5vZGUgdG
8gUmVnaXN0cnkgY29tbXVuaWNhdGlvbnM/IiwiY3JlYXRlZCI6
MTYxMjQ1OTU3OTA2NX0sImV0VThmeU45Y09Ld3BLbUIiOnsiZG
lzY3Vzc2lvbklkIjoiTmFsWHVkZHNWQTA0TVlQUCIsInN1YiI6
ImdoOjY0NDEwMTE5IiwidGV4dCI6IklzIHRoaXMgYmV5b25kIH
RoZSBzY29wZSBvZiB0aGlzIGd1aWRlPyIsImNyZWF0ZWQiOjE2
MTI0NTk2MzAwNjZ9LCJvUnVXck5BZFZCZmp4SkxKIjp7ImRpc2
N1c3Npb25JZCI6ImVQZ0dEQXQ4cHZBZG5lb2YiLCJzdWIiOiJn
aDo2NDQxMDExOSIsInRleHQiOiJMaW5raW5nIHRvIHJlc291cm
NlcyBmcm9tIHRpdGxlIFtjb21wYWN0XSwgb3IgYXMgZXhwbGlj
aXQgbGluayBpbiB0aGUgcHJvc2UgW3VzZWZ1bCBmb3IgbXVsdG
lwbGUgcmVzb3VyY2VzXT8gT3IgbWl4ZWQvYm90aD8iLCJjcmVh
dGVkIjoxNjEyNTE4MTI1MDAwfX0sImhpc3RvcnkiOlstMzIxNT
QyMDM1LDExNDM2ODgzNDgsLTEwNDczNzUxNjcsLTExNjk1MjE0
MTYsNDY1MzcxNzk5LC01OTg2Mzk2MTksMTQ2MTQ1MzczMCwxND
M5NzU2NTE2LDE4NzgxNTUwMTMsLTg0Mzc5NzQyNCwtMTUwNjQ2
Mzg4MSwtNzg4OTk0NDEsLTE4NTk1OTk1MTEsLTUxNDY5OTc1Ni
wtODM3MjE4ODUwLDEyNTM3ODUzMywxODg1NTQwOTI3LC0xNjM2
NTI5NzcyLDM3MTMwMDQzOSwxNjY5MzgzNDkzXX0=
-->