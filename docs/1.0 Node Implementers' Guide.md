# NMOS Authorization: Node  Implementers' Guide
_(c) AMWA 2020, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_

## Document Scope
[Overview including defining scope of this guide i.e. authorization only, excluding transport level security or certificate provisioning].  
_[Question: if we have this implementation guide focus purely on implementing a node, we don't need to include the broadcast controller sections, and can concentrate on Client Credential flow?]_  

IS-10 is based on the OAuth2 recommendation, it is used for protecting the NMOS APIs, which allowing NMOS Node and NMOS Registry to give the limited access for the third party application. Third application including Broadcast Controller System, which queries NMOS Registry via IS-04 for all the registered Nodes information and making IS-05 Node connections. NMOS Nodes are also acted as the third party for the NMOS Registry to perform IS-04 node registration.  In this document, we are focused on the NMOS Node implemenation.
    
## Pre-requisites
_[Question: pre-requisites can be split into knowledge required (OAuth 2.0, JWT), and infrastructure required for implementation (Auth server). Should these be in separate sections or part of the same?]_  
  You should be familiar the following specification and technologies before beginning 
  
### NMOS IS-04, IS-05, IS-08
[Links to resources/specifications]  
[IS-04](https://specs.amwa.tv/is-04/)
[IS-05](https://specs.amwa.tv/is-05/)
[IS-08](https://specs.amwa.tv/is-08/)
[IS-10](https://specs.amwa.tv/is-10/)
  
### OAuth 2.0
Client Credentials Flow  
[Links to resources/specifications]  

MF: One useful set of articles is a 4 part series that appears to be on several sites. The links to the first 3 parts on one site are:  
[Part 1](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st "https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st")
[Part 2](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-2-oauth20)
[Part 3](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-3-jwt)
The 4th part is mainly a specific code example in Java, so doesn't seem as relevant

### JavaScript Web Tokens (JWT)
[Links to resources/specifications]
[debugger-io](https://jwt.io/#debugger-io)  seems to be a useful link for experimenting with building and decoding JWTs  
  
## Authenticated API Calls
[Description of how to modify the IS-04, IS-05 and IS-08 API calls to use OAuth 2.0 tokens]  
### Node to Authentication Server Interactions  
[Description of interaction between node/device and the authorization server]
[ Include Sequence Diagram]
_Maybe include this as part of the Node to Registry communications?

1. Node [discoveries Authorization Server](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#dns-sd-advertisement) via unicast DNS-SD.
2. Node [fetches Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata response:

	HTTP/1.1  200  OK
	Content-Type: application/json

	{
	  "issuer": "https://authorization-server.com",
	  "authorization_endpoint": "authorization-server.com/authorize",
	  "token_endpoint": "https://authorization-server.com/token",
	  "token_introspection_endpoint": "https://authorization-server.com/introspect",
	  "userinfo_endpoint": "https://authorization-server.com/userinfo",
	  "end_session_endpoint": "https://authorization-server.com/logout",
	  "jwks_uri": "https://authorization-server.com/jwks",	  
	  "grant_types_supported": [
	    "authorization_code",
	    "implicit",
	    "refresh_token",
	    "password",
	    "client_credentials"
	  ],
	  "response_types_supported": [
	    "code",
	    "none",
	    "id_token",
	    "token",
	    "id_token token",
	    "code id_token",
	    "code token",
	    "code id_token token"
	  ],
	  "id_token_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "registration_endpoint": "https://authorization-server.com/register",
	  "token_endpoint_auth_methods_supported": [
	    "private_key_jwt",
	    "client_secret_basic",
	    "client_secret_post",
	    "tls_client_auth",
	    "client_secret_jwt"
	  ],
	  "token_endpoint_auth_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
	  ],
	  "code_challenge_methods_supported": [
	    "plain",
	    "S256"
	  ]
	}

3. If Node has not yet registered to the Authorization Server (it can be done by fetching the client metadata using the registration_access_token on the registration_client_uri which were given while executing the client registration), use [client crendentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials) to perform [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration).

Example client registration request:

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer {initial access token}
    
	{
	 "client_name": "My Example Client",
	 "grant_types": ["client_credentials"],
	 "jwks_uri": "https://client.example.org/my_public_keys.jwks",
	 "response_types": ["none"],
	 "scope": "registration",
	 "token_endpoint_auth_method": "private_key_jwt"
	} 

Example response:

    HTTP/1.1  201  Created
    Content-Type: application/json
    	
    {
     "client_id": "xxxxxxxxxx",
     "client_name":"My Example Client",
     "grant_types":["client_credentials"],
     "jwks_uri":"https://client.example.org/my_public_keys.jwks",
     "redirect_uris":[],
     "registration_access_token":"eyJhbGciOiJIUzI1NiIsInR5c...",
     "registration_client_uri":"https://authorization-server.com/xxxxxxxxxx",
     "response_types":[],
     "token_endpoint_auth_method":"private_key_jwt"
     }

4. Node starts the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response) to fetch bearer token.

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

Example token response:

	HTTP/1.1  200  OK
	Content-Type: application/json
		{"access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJPNFFFaWNTNzBzMURXRnl0ODRuaUk4MFoyU0xzZE5yVnllR3dKZThnOHF3In0.eyJleHAiOjE2MTIzMDEzMDksImlhdCI6MTYxMjMwMTEyOSwianRpIjoiZWU3OWJhNjYtNzc4YS00NDAxLThjMzAtNDY1OTYyNTI3OTM5IiwiaXNzIjoiaHR0cHM6Ly9iYmMtMS53b3Jrc2hvcC5ubW9zLnR2OjgwMDIvYXV0aC9yZWFsbXMvbWFzdGVyIiwiYXVkIjoiKi53b3Jrc2hvcC5ubW9zLnR2Iiwic3ViIjoiYmFmNDE0ZTgtMzRiNy00NTAzLWE4N2UtM2I0ZWI5MTZjZTNhIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiMzBiYWY2MTctMTc0NC00YzI0LTliYWYtMjIzNTFiZWMxYTczIiwic2Vzc2lvbl9zdGF0ZSI6IjRkYThhNmQxLTg3NjItNGI1ZS1hNzVkLTVhNzE3MTk3ODRlMCIsImFjciI6IjEiLCJzY29wZSI6InJlZ2lzdHJhdGlvbiIsIngtbm1vcy1yZWdpc3RyYXRpb24iOnsicmVhZCI6WyIqIl0sIndyaXRlIjpbIioiXX0sImNsaWVudElkIjoiMzBiYWY2MTctMTc0NC00YzI0LTliYWYtMjIzNTFiZWMxYTczIiwiY2xpZW50SG9zdCI6IjE3Mi4xNy4wLjEiLCJjbGllbnRBZGRyZXNzIjoiMTcyLjE3LjAuMSJ9.F7uM-pLvDa0M0x92559WBDMKTPMutq2zFzw9FhEd6FY0e-aIJtmlwd3wdBFdLUAGEwaf0gevLhStl2hD-nMxJmPosSOPrmWCFnvzHNsItLpvzUbmCxUcuPipXGtsKhRJi28z27nO7bNQSEbR3WWHJkJzJr-a-QmLq8kuBX-YvRebFhdGf3N04VM89ttMjX8tFowJXTOtBbZs1n66-dFNFDD3prCd_fh8R8VN3KfFfIrgY3St44fmfc0CXEwE1N4blQHEPAssq0asw5McRQAbg5LSN-WGlc_PF9oI9fuXR2tQz6noJv573xlOMirrzPNHd5Uy-aquYsUJc91UohlCwxB60HTpH4_uh-aNoaGPxbm6m1SIwVvBZi1iiJKl5DFbT0u_Ey2FOHl6TSvQtB58mATIvxqJoW70fi9RhvoavfRJ7Y3L9z6nRBxJmjpa3xtStugRo0KILPhEF1M51upU58m49kdG6K-I_FCB3zWekNv-Nt6bHmiCjqFRZmwKLLK1ZXRtwCRsFvSMMDPxK25L4M1w_LzKpHXywwyriZu_fmheIAzfMXDOap0XBrN31wlubGNeARKCg0-lJAzERigmLhPF7RbgzZcd3LWxmAQRDkKgbP1bXxZdUtWLfOpxh-euCjmEUwfyLgelclO8IlOjA6aNWWvm8vnBHD4f-HKTTQk","expires_in":180,"not-before-policy":0,"refresh_expires_in":1800,"refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJkY2ExOGFmNi1jYWFiLTQyY2EtOGQ1Ni1mYjNmMTk2MjM1MzEifQ.eyJleHAiOjE2MTIzMDI5MjksImlhdCI6MTYxMjMwMTEyOSwianRpIjoiNTcxNzg5MGMtMjE2Zi00Njc0LThlYjgtODdhZGIzYjRkNmY0IiwiaXNzIjoiaHR0cHM6Ly9iYmMtMS53b3Jrc2hvcC5ubW9zLnR2OjgwMDIvYXV0aC9yZWFsbXMvbWFzdGVyIiwiYXVkIjoiaHR0cHM6Ly9iYmMtMS53b3Jrc2hvcC5ubW9zLnR2OjgwMDIvYXV0aC9yZWFsbXMvbWFzdGVyIiwic3ViIjoiYmFmNDE0ZTgtMzRiNy00NTAzLWE4N2UtM2I0ZWI5MTZjZTNhIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6IjMwYmFmNjE3LTE3NDQtNGMyNC05YmFmLTIyMzUxYmVjMWE3MyIsInNlc3Npb25fc3RhdGUiOiI0ZGE4YTZkMS04NzYyLTRiNWUtYTc1ZC01YTcxNzE5Nzg0ZTAiLCJzY29wZSI6InJlZ2lzdHJhdGlvbiJ9.XYvuYVpxUdFwtujFwYGHDVE_IOZLEfsZAQi0zRNYa4M","scope":"registration","session_state":"4da8a6d1-8762-4b5e-a75d-5a71719784e0","token_type":"bearer"}

where client_assertion is a self signed JWT and client_id is the result from client registration.

5. Node refreshes bearer token as in step 4 at least 15 seconds before token expiry (i.e. [half-life of the token](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime)).
6. Node fetches [Authorization Server public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) in every hour for  validating incoming access token.

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
7. Node switches to next available Authorization Server, if it's unable to commuincate with the connected Authorization Server.
  
### Node to Registry (IS-04 Registration API)  
[ Include Sequence Diagram]
MF: I think the textual steps are:

1. Node is registered with the authorization server (flow diagram of steps?)  
2. Node sends client credentials (and other information?) to authorization server to get access token 
3. Node sends access token to registry as extra HTTP header with existing registry communications
4. Does a description of the registry behaviour on receipt of the access token make sense here, or should that go elsewhere and have a link back to here? I believe it is essentially the same thing as stage 6 of the "controller to node" interaction below.  
5. If I understand correctly, the refresh token does not apply (or doesn't make much sense) in the client credentials grant workflow. So when the access token expires (checking IAT itself, or authorisation failure return from registry), the node just repeats step (2) 
  
### Controller to Node (IS-05, IS-08 and IS-04 Node API)  
[ Include Sequence Diagram]  

_MF: I believe the pattern for accessing all three of these APIs is very similar_

MF: I think the textual steps are:
1) Controller is registered with the authorisation server (does that apply, as I think it counts as a "public client"?)
2) Controller user gets redirected to authorisation server on login, to authenticate with authorisation server
3) Authorisation server returns redirect to client browser(?) as part of the authorisation code grant
4) Client (presumably part of the controller, not the user's browser) obtains access token from authorisation server for access to NMOS node resources (what extra information does it need to send?)
5) Controller sends access token to Node as part of HTTP headers on access to resources
6) Node has to verify the access token:
6a) Verify the signature of the token. This requires obtaining the public key from the authorisation server, and then applying a "RSASSA-PKCS1-v1_5 using SHA-512" check on the signature in the token
6b) Verify the fields of the token are correct, including expiry time, iat/nbf (IS-10 doesn't mention nbf, but other JWT texts do), aud and iss, plus x-nmos-* claims.
7) If stage 6 passes, then return the requested data, otherwise return an authorisation failure HTTP code.

_PB: as required, further guidance on spec details e.g. the NBF field question_  

### Event & Tally (IS-07)
[ Include Sequence Diagram]  
_MF: I believe the pattern for this API is different, as it can include node-to-node communication, and is mainly based around websockets or MQTT, rather than traditional HTTP requests_

## Implementation resources [better heading than this - too ambiguous]  
### Authentication Server
[An auth server is required - link to open source implementations such as Keycloak]
_MF: Guidance on how to set it up for this. See AB wiki guide plus how to segment network. AB: maybe BBC could provide container with config, helped with docker-compose._  
  
### NMOS Testing Tool
[Description and links to the NMOS Testing tool]  
  
### VPN-based testing and virtual workshops
_[Question Only available to AMWA members, so probably best excluded from this guide?]_

_PB: yes, but could reference how we did this (TE blog post++)_

## References
-   external OAuth 2.0 and JWT tutorials
-   Sony slides (updated)
-   not-as-yet-written IS-04/05/08 implementers' guides
-   Existing wiki implementers info
-   Initial white papers from BBC










<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJpeVREbld2VTN4ckFiQkoyIjp7In
N0YXJ0IjoxMDM2OCwiZW5kIjoxMDU0OCwidGV4dCI6IjEuIE5v
ZGUgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBhdXRob3JpemF0aW
9uIHNlcnZlciAoZmxvdyBkaWFncmFtIG9mIHN0ZXBzPynigKYi
fSwidXpLVWdzcGt6ZEJ2cThQSiI6eyJzdGFydCI6MTEzODUsIm
VuZCI6MTE1MDQsInRleHQiOiIxKSBDb250cm9sbGVyIGlzIHJl
Z2lzdGVyZWQgd2l0aCB0aGUgYXV0aG9yaXNhdGlvbiBzZXJ2ZX
IgKGRvZXMgdGhhdCBhcHBseSwgYXPigKYifSwiUkRqTXZ2bnNW
MU5FZTdOVSI6eyJzdGFydCI6MTA5MDUsImVuZCI6MTExNzIsIn
RleHQiOiI1LiBJZiBJIHVuZGVyc3RhbmQgY29ycmVjdGx5LCB0
aGUgcmVmcmVzaCB0b2tlbiBkb2VzIG5vdCBhcHBseSAob3IgZG
9lc24ndCBtYWtl4oCmIn19LCJjb21tZW50cyI6eyJkS0l5ZWdl
Z29rZ2lQZU9GIjp7ImRpc2N1c3Npb25JZCI6Iml5VERuV3ZVM3
hyQWJCSjIiLCJzdWIiOiJnaDozMDIzMTMyMSIsInRleHQiOiJk
ZXNjcmliZWQgaW4gc3RlcCAzIGFuZCA0IG9mIE5vZGUgdG8gQX
V0aGVudGljYXRpb24gU2VydmVyIEludGVyYWN0aW9ucyIsImNy
ZWF0ZWQiOjE2MTIzOTg1MjE0MDh9LCJrcDVRQ2F1RjRmd2JHWW
JsIjp7ImRpc2N1c3Npb25JZCI6InV6S1Vnc3BremRCdnE4UEoi
LCJzdWIiOiJnaDozMDIzMTMyMSIsInRleHQiOiJtYXliZSB0aG
lzIGJpdCBzaG91bGQgYmUgZGVzY3JpYmVkIGluIGFub3RoZXIg
ZG9jICBDb250cm9sbGVyIEltcGxlbWVuYXRlciBHdWlkZSBzZW
N0aW9uIENvbnRyb2xsZXIgdG8gQXV0aGVudGljYXRpb24gU2Vy
dmVyIEludGVyYWN0aW9ucyIsImNyZWF0ZWQiOjE2MTIzOTg4NT
Q0NTl9LCJraFFZcHNydWMzbEhtSEFMIjp7ImRpc2N1c3Npb25J
ZCI6IlJEak12dm5zVjFORWU3TlUiLCJzdWIiOiJnaDozMDIzMT
MyMSIsInRleHQiOiJkZXNjcmliZWQgaW4gc3RlcCA1IG9mIE5v
ZGUgdG8gQXV0aGVudGljYXRpb24gU2VydmVyIEludGVyYWN0aW
9ucyIsImNyZWF0ZWQiOjE2MTIzOTg5MjYxNjh9fSwiaGlzdG9y
eSI6WzE4MTQ1ODQ0OTYsOTMxMjQ4NTcxLC0xOTczMTAzMTY4LC
0yMDI1MzI1OTcxLC0yMTI5OTU0MjU2LDE2NTMzODM3MzEsMjY3
NzAyMzUyLC0xMTI5MjA4NDEsLTIxMTQ0ODUwMzgsODE0ODAxND
YwLDEyODYwMTU4NjMsMTc0MDQ4NDMzMyw2NjQ0NDYwMjksMTAz
MDQ1MTY4OSwtOTY5NDcxNDEsMTIyNTczMzI3OSwyOTQ0NDU4OD
EsLTYxMzUxMTI0MCwxNTc2OTk5MjkyLDE2NDcwOTQwMTJdfQ==

-->