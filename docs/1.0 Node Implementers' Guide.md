# NMOS Authorization: Node  Implementation Guide
_(c) AMWA 2020, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_

## Document Scope
This document is intended as a guide for implementers who want to add NMOS Authorization to their NMOS Nodes, where that Node is a typical broadcast device. (Implementation of NMOS Authorization in Nodes that act as controllers is NOT within the scope of this document [REF to NMOS Controller guide]).
   
## Pre-requisites

In order to use this guide, you should be familiar with the following specification and technologies before beginning.
  
### NMOS IS-04, IS-05, IS-08
#### [IS-04 Registration & Discovery](https://specs.amwa.tv/is-04/) & [IS-05 Connection Management](https://specs.amwa.tv/is-05/)
As well as a familiarity with the standards, it is also assumed that you already have a working implementation of IS-04 and IS-05 for your NMOS Node.

#### [IS-08 Audio Channel Mapping](https://specs.amwa.tv/is-08/)
If your device has audio capability, then as well as being familiar with the standard, it is assumed that you already have a working implementation of IS-08 for your NMOS Node
#### [IS-10 Authorization](https://specs.amwa.tv/is-10/) 

The IS-10 Authorization is based on OAuth2 and is used for protecting NMOS APIs, and controlling access to IS-04, IS-05 and IS-08 APIs.
  
### OAuth 2.0
Client Credentials Flow  

MF: One useful set of articles is a 4 part series that appears to be on several sites. The links to the first 3 parts on one site are:  
[Part 1](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st "https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st")
[Part 2](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-2-oauth20)
[Part 3](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-3-jwt)
The 4th part is mainly a specific code example in Java, so doesn't seem as relevant

### JavaScript Web Tokens (JWT)
[Links to resources/specifications]
[debugger-io](https://jwt.io/#debugger-io)  seems to be a useful link for experimenting with building and decoding JWTs  
  
## Authenticated API Calls

### Node to Authentication Server Interactions  

![Client Credential Flow](./diagrams/client_credentials_flow.png)

1. Node [discoveries Authorization Server](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discove	ry.html#dns-sd-advertisement) via unicast DNS-SD.
2. Node [fetches Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	{
	  "issuer": "https://authorization-server.com",
	  "authorization_endpoint": "authorization-server.com/authorize",
	  "token_endpoint": "https://authorization-server.com/token",
	  "token_introspection_endpoint": "https://authorization-server.com/introspect",
	  "userinfo_endpoint": "https://authorization-server.com/userinfo",
	  "end_session_endpoint": "https://authorization-server.com/logout",
	  "jwks_uri": "https://authorization-server.com/jwks",	  
	  "grant_types_supported": [
	    "authorization_code",
	    "implicit",
	    "refresh_token",
	    "password",
	    "client_credentials"
	  ],
	  "response_types_supported": [
	    "code",
	    "none",
	    "id_token",
	    "token",
	    "id_token token",
	    "code id_token",
	    "code token",
	    "code id_token token"
	  ],
	  "id_token_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "registration_endpoint": "https://authorization-server.com/register",
	  "token_endpoint_auth_methods_supported": [
	    "private_key_jwt",
	    "client_secret_basic",
	    "client_secret_post",
	    "tls_client_auth",
	    "client_secret_jwt"
	  ],
	  "token_endpoint_auth_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
	  ],
	  "code_challenge_methods_supported": [
	    "plain",
	    "S256"
	  ]
	}

3. If Node has not yet registered to the Authorization Server (it can be verified by fetching the client metadata using the registration_access_token on the registration_client_uri which were given while executing the client registration), use [client crendentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials) to perform [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration).

Example client registration request including initial access token:

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
    
	{
	 "client_name": "My Example Client",
	 "grant_types": ["client_credentials"],
	 "jwks_uri": "https://client.example.org/my_public_keys.jwks",
	 "response_types": ["none"],
	 "scope": "registration",
	 "token_endpoint_auth_method": "private_key_jwt"
	}

Example response:

    HTTP/1.1 201 Created
    Content-Type: application/json
    	
    {
     "client_id": "xxxxxxxxxx",
     "client_name":"My Example Client",
     "grant_types":["client_credentials"],
     "jwks_uri":"https://client.example.org/my_public_keys.jwks",
     "redirect_uris":[],
     "registration_access_token":"eyJhbGciOiJIUzI1NiIsInR5c...",
     "registration_client_uri":"https://authorization-server.com/xxxxxxxxxx",
     "response_types":[],
     "token_endpoint_auth_method":"private_key_jwt"
     }

4. Node starts the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response) to fetch bearer token.

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

where client_assertion is a self signed JWT and client_id is the result from client registration.

Example token response:

	HTTP/1.1 200 OK
	Content-Type: application/json
	
	{
	 "access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
	 "expires_in":180,
	 "scope":"registration",
	 "token_type":"bearer"
	}

5. Node refreshes bearer token as in step 4 at least 15 seconds before token expiry (i.e. [half-life of the token](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime)).
6. Node fetches [Authorization Server public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) in every hour for  validating incoming access token.

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
Example server public keys response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	[
	 {
	  "alg":"RS256",
	  "e":"AQAB",
	  "kid":"aRxkfaepyicuogJnoaXfUJAEDwiDQ3o914n2JNqToZ0",
	  "kty":"RSA",
	  "n":"jBRq3QfleVgYxjS3q-tmK8686Pc2HvR50kxfB6l...",
	  "use":"sig",
	  "x5c":["MIICmzCCAYMCBgFxiHgcuzANBgkqhkiG9w0BAQ..."],
	  "x5t":"qaEz9PpliodKhNXA5jqiUky5-RU",
	  "x5t#S256":"hfJS5jB9chso-iMQ7-QNAIXFPFwz6SjrohG81r6IxyE"
	 },
	 {
	  "alg":"ES256",
	  "crv":"P-256",
	  "kid":"jMRpEWZ8_-1pmdpGqEo4ZSCb7pltOVuoQQc46aYa7RM",
	  "kty":"EC",
	  "use":"sig",
	  "x":"e7DQRay3ZWCj-Y_-Ww-QN-m95KV2IBVpZ2raP3CF5XU",
	  "y":"ay2UR1ohsrWhJgsv8T0cV66yivD4kA9_3YV8RJFjD3k"
	 },
	 {
	  "alg":"RS512",
	  "e":"AQAB",
	  "kid":"O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
	  "kty":"RSA",
	  "n":"yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkmTYa...",
	  "use":"sig",
	  "x5c":["MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAw..."],
	  "x5t":"LD3awp-sYoVbcfwOgB9BRO4HFYQ",
	  "x5t#S256":"yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
	 }
	]

7. Node switches to next available Authorization Server, if it's unable to commuincate with the connected Authorization Server.
  
### Node to Registry (IS-04 Registration API)  
[ Include Sequence Diagram]
MF: I think the textual steps are:

1. Node is registered with the authorization server (flow diagram of steps?)  
2. Node sends client credentials (and other information?) to authorization server to get access token 
3. Node sends access token to registry as extra HTTP header with existing registry communications

Example resource registration request:

	POST /resource HTTP/1.1
    Host: registry.example.org
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...
    
    {
     "type": "node",
     "data": 
      description:"host1",
      hostname:"host1",
      label:"host1",
      ...
     }
    }

5. Does a description of the registry behaviour on receipt of the access token make sense here, or should that go elsewhere and have a link back to here? I believe it is essentially the same thing as stage 6 of the "controller to node" interaction below.  
6. If I understand correctly, the refresh token does not apply (or doesn't make much sense) in the client credentials grant workflow. So when the access token expires (checking IAT itself, or authorisation failure return from registry), the node just repeats step (2) 
  
### Controller to Node (IS-05, IS-08 and IS-04 Node API)  
[ Include Sequence Diagram]  

_MF: I believe the pattern for accessing all three of these APIs is very similar_

MF: I think the textual steps are:
1) Controller is registered with the authorisation server (does that apply, as I think it counts as a "public client"?)
2) Controller user gets redirected to authorisation server on login, to authenticate with authorisation server
3) Authorisation server returns redirect to client browser(?) as part of the authorisation code grant
4) Client (presumably part of the controller, not the user's browser) obtains access token from authorisation server for access to NMOS node resources (what extra information does it need to send?)
5) Controller sends access token to Node as part of HTTP headers on access to resources
6) Node has to verify the access token:
6a) Verify the signature of the token. This requires obtaining the public key from the authorisation server, and then applying a "RSASSA-PKCS1-v1_5 using SHA-512" check on the signature in the token
6b) Verify the fields of the token are correct, including expiry time, iat/nbf (IS-10 doesn't mention nbf, but other JWT texts do), aud and iss, plus x-nmos-* claims.
7) If stage 6 passes, then return the requested data, otherwise return an authorisation failure HTTP code.

_PB: as required, further guidance on spec details e.g. the NBF field question_  

### Event & Tally (IS-07)
[ Include Sequence Diagram]  
_MF: I believe the pattern for this API is different, as it can include node-to-node communication, and is mainly based around websockets or MQTT, rather than traditional HTTP requests_

## Implementation resources 
### Authentication Server
[An auth server is required - link to open source implementations such as Keycloak]
_MF: Guidance on how to set it up for this. See AB wiki guide plus how to segment network. AB: maybe BBC could provide container with config, helped with docker-compose._  
  
### NMOS Testing Tool
[Description and links to the NMOS Testing tool]  
  
### VPN-based testing and virtual workshops
_[Question Only available to AMWA members, so probably best excluded from this guide?]_

_PB: yes, but could reference how we did this (TE blog post++)_

## References
-   external OAuth 2.0 and JWT tutorials
-   Sony slides (updated)
-   not-as-yet-written IS-04/05/08 implementers' guides
-   Existing wiki implementers info
-   Initial white papers from BBC










<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJpeVREbld2VTN4ckFiQkoyIjp7In
RleHQiOiIxLiBOb2RlIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUg
YXV0aG9yaXphdGlvbiBzZXJ2ZXIgKGZsb3cgZGlhZ3JhbSBvZi
BzdGVwcz8p4oCmIiwic3RhcnQiOjg3NTAsImVuZCI6ODkzMH0s
InV6S1Vnc3BremRCdnE4UEoiOnsidGV4dCI6IjEpIENvbnRyb2
xsZXIgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBhdXRob3Jpc2F0
aW9uIHNlcnZlciAoZG9lcyB0aGF0IGFwcGx5LCBhc+KApiIsIn
N0YXJ0IjoxMDEwNSwiZW5kIjoxMDIyNH0sIlJEak12dm5zVjFO
RWU3TlUiOnsidGV4dCI6IjUuIElmIEkgdW5kZXJzdGFuZCBjb3
JyZWN0bHksIHRoZSByZWZyZXNoIHRva2VuIGRvZXMgbm90IGFw
cGx5IChvciBkb2Vzbid0IG1ha2XigKYiLCJzdGFydCI6OTYyNi
wiZW5kIjo5ODkyfSwiYmNWUnB2cTByVmY1OG15TSI6eyJzdGFy
dCI6MTMyLCJlbmQiOjE0NiwidGV4dCI6IkRvY3VtZW50IFNjb3
BlIn0sIlVqTkIwZXVaTlg5MVZKRnIiOnsic3RhcnQiOjQ1Niwi
ZW5kIjo0NzAsInRleHQiOiJQcmUtcmVxdWlzaXRlcyJ9LCJCMl
pyemJjZ004VFVuSG5BIjp7InN0YXJ0IjoxMzU3LCJlbmQiOjEz
ODAsInRleHQiOiJDbGllbnQgQ3JlZGVudGlhbHMgRmxvdyJ9LC
JYdnA5Qk5mYWw4OGdZS00wIjp7InN0YXJ0IjoyMTI4LCJlbmQi
OjIxNTEsInRleHQiOiJBdXRoZW50aWNhdGVkIEFQSSBDYWxscy
J9LCJ6UzNNWmZwVXFpa0Z4Z0MwIjp7InN0YXJ0IjoyMTU3LCJl
bmQiOjIxOTksInRleHQiOiJOb2RlIHRvIEF1dGhlbnRpY2F0aW
9uIFNlcnZlciBJbnRlcmFjdGlvbnMifSwiTmFsWHVkZHNWQTA0
TVlQUCI6eyJzdGFydCI6MTEzMjUsImVuZCI6MTEzNDYsInRleH
QiOiJFdmVudCAmIFRhbGx5IChJUy0wNykifSwiSmFRRlp2cWtp
am5uaVBzUSI6eyJzdGFydCI6MTE1NjcsImVuZCI6MTE1OTEsIn
RleHQiOiJJbXBsZW1lbnRhdGlvbiByZXNvdXJjZXMifSwiZVBn
R0RBdDhwdkFkbmVvZiI6eyJzdGFydCI6NjIzLCJlbmQiOjcyMi
widGV4dCI6IiMjIyMgW0lTLTA0IFJlZ2lzdHJhdGlvbiAmIERp
c2NvdmVyeV0oaHR0cHM6Ly9zcGVjcy5hbXdhLnR2L2lzLTA0Ly
kgJiBbSVMtMDUgQ2/igKYifX0sImNvbW1lbnRzIjp7ImRLSXll
Z2Vnb2tnaVBlT0YiOnsiZGlzY3Vzc2lvbklkIjoiaXlURG5Xdl
UzeHJBYkJKMiIsInN1YiI6ImdoOjMwMjMxMzIxIiwidGV4dCI6
ImRlc2NyaWJlZCBpbiBzdGVwIDMgYW5kIDQgb2YgTm9kZSB0by
BBdXRoZW50aWNhdGlvbiBTZXJ2ZXIgSW50ZXJhY3Rpb25zIiwi
Y3JlYXRlZCI6MTYxMjM5ODUyMTQwOH0sImtwNVFDYXVGNGZ3Yk
dZYmwiOnsiZGlzY3Vzc2lvbklkIjoidXpLVWdzcGt6ZEJ2cThQ
SiIsInN1YiI6ImdoOjMwMjMxMzIxIiwidGV4dCI6Im1heWJlIH
RoaXMgYml0IHNob3VsZCBiZSBkZXNjcmliZWQgaW4gYW5vdGhl
ciBkb2MgIENvbnRyb2xsZXIgSW1wbGVtZW5hdGVyIEd1aWRlIH
NlY3Rpb24gQ29udHJvbGxlciB0byBBdXRoZW50aWNhdGlvbiBT
ZXJ2ZXIgSW50ZXJhY3Rpb25zIiwiY3JlYXRlZCI6MTYxMjM5OD
g1NDQ1OX0sImtoUVlwc3J1YzNsSG1IQUwiOnsiZGlzY3Vzc2lv
bklkIjoiUkRqTXZ2bnNWMU5FZTdOVSIsInN1YiI6ImdoOjMwMj
MxMzIxIiwidGV4dCI6ImRlc2NyaWJlZCBpbiBzdGVwIDUgb2Yg
Tm9kZSB0byBBdXRoZW50aWNhdGlvbiBTZXJ2ZXIgSW50ZXJhY3
Rpb25zIiwiY3JlYXRlZCI6MTYxMjM5ODkyNjE2OH0sIjNQZ0pp
NmJZdERTVzZmZjciOnsiZGlzY3Vzc2lvbklkIjoiYmNWUnB2cT
ByVmY1OG15TSIsInN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6
Ik92ZXJ2aWV3IGluY2x1ZGluZyBkZWZpbmluZyBzY29wZSBvZi
B0aGlzIGd1aWRlIGkuZS4gYXV0aG9yaXphdGlvbiBvbmx5LCBl
eGNsdWRpbmcgdHJhbnNwb3J0IGxldmVsIHNlY3VyaXR5IG9yIG
NlcnRpZmljYXRlIHByb3Zpc2lvbmluZyIsImNyZWF0ZWQiOjE2
MTI0NTk0Njc0NTR9LCJ0NHhSUWI0R3FRdDJEeDFhIjp7ImRpc2
N1c3Npb25JZCI6IlVqTkIwZXVaTlg5MVZKRnIiLCJzdWIiOiJn
aDo2NDQxMDExOSIsInRleHQiOiJRdWVzdGlvbjogcHJlLXJlcX
Vpc2l0ZXMgY2FuIGJlIHNwbGl0IGludG8ga25vd2xlZGdlIHJl
cXVpcmVkIChPQXV0aCAyLjAsIEpXVCksIGFuZCBpbmZyYXN0cn
VjdHVyZSByZXF1aXJlZCBmb3IgaW1wbGVtZW50YXRpb24gKEF1
dGggc2VydmVyKS4gU2hvdWxkIHRoZXNlIGJlIGluIHNlcGFyYX
RlIHNlY3Rpb25zIG9yIHBhcnQgb2YgdGhlIHNhbWU/IiwiY3Jl
YXRlZCI6MTYxMjQ1OTQ5MTYzOH0sIllGN1VhQkU4QUFCVnJyb0
QiOnsiZGlzY3Vzc2lvbklkIjoiQjJacnpiY2dNOFRVbkhuQSIs
InN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6IkluY2x1ZGUgbG
lua3MgdG8gcmVzb3VyY2VzL3NwZWNpZmljYXRpb25zIiwiY3Jl
YXRlZCI6MTYxMjQ1OTUyODY4OH0sInBwSDJJM1lpSUNvdWVwMT
QiOnsiZGlzY3Vzc2lvbklkIjoiWHZwOUJOZmFsODhnWUtNMCIs
InN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6IkRlc2NyaXB0aW
9uIG9mIGhvdyB0byBtb2RpZnkgdGhlIElTLTA0LCBJUy0wNSBh
bmQgSVMtMDggQVBJIGNhbGxzIHRvIHVzZSBPQXV0aCAyLjAgdG
9rZW5zIiwiY3JlYXRlZCI6MTYxMjQ1OTU1NzMyMn0sIm9TMUF5
MGxpUnhrdnNmOUEiOnsiZGlzY3Vzc2lvbklkIjoielMzTVpmcF
VxaWtGeGdDMCIsInN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6
Ik1heWJlIGluY2x1ZGUgdGhpcyBhcyBwYXJ0IG9mIHRoZSBOb2
RlIHRvIFJlZ2lzdHJ5IGNvbW11bmljYXRpb25zPyIsImNyZWF0
ZWQiOjE2MTI0NTk1NzkwNjV9LCJldFU4ZnlOOWNPS3dwS21CIj
p7ImRpc2N1c3Npb25JZCI6Ik5hbFh1ZGRzVkEwNE1ZUFAiLCJz
dWIiOiJnaDo2NDQxMDExOSIsInRleHQiOiJJcyB0aGlzIGJleW
9uZCB0aGUgc2NvcGUgb2YgdGhpcyBndWlkZT8iLCJjcmVhdGVk
IjoxNjEyNDU5NjMwMDY2fSwiNW9ybklWV0NrQnVuRlI5ViI6ey
JkaXNjdXNzaW9uSWQiOiJKYVFGWnZxa2lqbm5pUHNRIiwic3Vi
IjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiQmV0dGVyIGhlYWRpbm
cgdGhhbiB0aGlzIC0gdG9vIGFtYmlndW91cz8iLCJjcmVhdGVk
IjoxNjEyNDU5NjQ4NzU0fSwib1J1V3JOQWRWQmZqeEpMSiI6ey
JkaXNjdXNzaW9uSWQiOiJlUGdHREF0OHB2QWRuZW9mIiwic3Vi
IjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiTGlua2luZyB0byByZX
NvdXJjZXMgZnJvbSB0aXRsZSBbY29tcGFjdF0sIG9yIGFzIGV4
cGxpY2l0IGxpbmsgaW4gdGhlIHByb3NlIFt1c2VmdWwgZm9yIG
11bHRpcGxlIHJlc291cmNlc10/IE9yIG1peGVkL2JvdGg/Iiwi
Y3JlYXRlZCI6MTYxMjUxODEyNTAwMH19LCJoaXN0b3J5IjpbLT
k1NTcxMTgxNSwtMTA0NzM3NTE2NywtMTE2OTUyMTQxNiw0NjUz
NzE3OTksLTU5ODYzOTYxOSwxNDYxNDUzNzMwLDE0Mzk3NTY1MT
YsMTg3ODE1NTAxMywtODQzNzk3NDI0LC0xNTA2NDYzODgxLC03
ODg5OTQ0MSwtMTg1OTU5OTUxMSwtNTE0Njk5NzU2LC04MzcyMT
g4NTAsMTI1Mzc4NTMzLDE4ODU1NDA5MjcsLTE2MzY1Mjk3NzIs
MzcxMzAwNDM5LDE2NjkzODM0OTMsMjEyMTk5Mjg3NF19
-->