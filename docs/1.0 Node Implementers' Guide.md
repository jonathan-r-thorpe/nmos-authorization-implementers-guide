# NMOS Authorization: Node  Implementation Guide
_(c) AMWA 2020, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_

## Document Overview
### Scope
This document is intended as a guide for implementers who want to add NMOS Authorization to their NMOS Nodes, where that Node is a typical broadcast device. (Implementation of NMOS Authorization in Nodes that act as controllers is NOT within the scope of this document [REF to NMOS Controller guide]).
### Structure

 - _Pre-requisites_ - what you need to know before you start your implementation.
 - _Authenticated API Calls_ - including NMOS Authorization in your Node implementation.
 - _Development Resources_ - useful tools and resources to help in your   
   implementation journey. 
- _References_ - In addition to the links to   
   articles, specifications and tutorials found within the guide, this  
   section contains other useful reading.

   
## Pre-requisites

Before using this guide, you should be familiar with the following specification and technologies.
  
### NMOS IS-04, IS-05, IS-08
#### [IS-04 Registration & Discovery](https://specs.amwa.tv/is-04/) & [IS-05 Connection Management](https://specs.amwa.tv/is-05/)
As well as a familiarity with the standards, it is also assumed that you already have a working implementation of IS-04 and IS-05 for your NMOS Node.
#### [IS-08 Audio Channel Mapping](https://specs.amwa.tv/is-08/)
If your device has audio capability, then as well as being familiar with the standard, it is assumed that you already have a working implementation of IS-08 for your NMOS Node.
#### [IS-10 Authorization](https://specs.amwa.tv/is-10/) 
The IS-10 Authorization specification is based on OAuth2 and is used for controlling access to IS-04, IS-05 and IS-08 APIs.  This guide will detail implementation of IS-10 in NMOS nodes (excluding controller nodes) for IS-04, IS-05 and IS-08 API calls.
  
### OAuth 2.0
Given that IS-10 is based on OAuth 2.0, a familiarity with the way OAuth 2.0 authentication works, and in particular the Client Credentials Grant flow, is required.  The authentication flows used by IS-10 are the Client Credentials Grant and the Authentication Code Flow. The latter is implemented when the NMOS node is a controller.

The following set of articles give a good grounding in OAuth 2.0.  They are from a four part series; the first three give a good grounding in OAuth 2.0 and JWT independent of implementation language. The fourth article is specific to Java implementations.
[Deep Dive Into OAuth2.0 and JWT (Part 1 Setting the Stage)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st "https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st")
[Deep Dive Into OAuth2.0 and JWT (Part 2 OAuth2.0)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-2-oauth20)
[Deep Dive to OAuth2.0 and JWT (Part 3)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-3-jwt)
[Deep Dive to OAuth2.0 and JWT (Part 4 JWT Use Case)](https://dzone.com/articles/what-is-zuul)

### JavaScript Web Tokens (JWT)
JavaScript Web Tokens is the preferred type of token used in IS-10.  A familiarity with JWT can be gained from the articles linked in the OAuth 2.0 section, or from this [introduction to JWT](https://jwt.io/introduction). 
  
## Implementing Authenticated API Calls

### Node to Authentication Server Interactions  
#### Discovery of the Authentication Server
In order to interact with the Authentication Server, you need to know where it is.  IS-10 specifies that Node the [Authentication Server should use unicast DNS-SD](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#dns-sd-advertisemen) to advertise itself to the  Node.

Once the node knows the whereabouts of the Authorization Server it can then fetch the [Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

_[Authentication server discovery sequence diagram??????]_

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	{
	  "issuer": "https://authorization-server.com",
	  "authorization_endpoint": "authorization-server.com/authorize",
	  "token_endpoint": "https://authorization-server.com/token",
	  "token_introspection_endpoint": "https://authorization-server.com/introspect",
	  "userinfo_endpoint": "https://authorization-server.com/userinfo",
	  "end_session_endpoint": "https://authorization-server.com/logout",
	  "jwks_uri": "https://authorization-server.com/jwks",	  
	  "grant_types_supported": [
	    "authorization_code",
	    "implicit",
	    "refresh_token",
	    "password",
	    "client_credentials"
	  ],
	  "response_types_supported": [
	    "code",
	    "none",
	    "id_token",
	    "token",
	    "id_token token",
	    "code id_token",
	    "code token",
	    "code id_token token"
	  ],
	  "id_token_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "registration_endpoint": "https://authorization-server.com/register",
	  "token_endpoint_auth_methods_supported": [
	    "private_key_jwt",
	    "client_secret_basic",
	    "client_secret_post",
	    "tls_client_auth",
	    "client_secret_jwt"
	  ],
	  "token_endpoint_auth_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
	  ],
	  "code_challenge_methods_supported": [
	    "plain",
	    "S256"
	  ]
	}

#### Client Registration 
NMOS nodes needs to first register themselves with the Authentication Server.  This is usually a one time operation that a Node would typically perform when first activated on the network.

The registration is done via a [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration) with the Authentication Server. The registration requires specification of the grant_type which should be set to  [client crendentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials)

![Client Registration](./images/client_registration.png)

Example client registration request including initial access token:

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
    
	{
	 "client_name": "My Example Client",
	 "grant_types": ["client_credentials"],
	 "jwks_uri": "https://client.example.org/my_public_keys.jwks",
	 "response_types": ["none"],
	 "scope": "registration",
	 "token_endpoint_auth_method": "private_key_jwt"
	}

Example response:

    HTTP/1.1 201 Created
    Content-Type: application/json
    	
    {
     "client_id": "xxxxxxxxxx",
     "client_name":"My Example Client",
     "client_id_issued_at": 1611940142,
     "grant_types":["client_credentials"],
     "jwks_uri":"https://client.example.org/my_public_keys.jwks",
     "redirect_uris":[],
     "registration_access_token":"eyJhbGciOiJIUzI1NiIsInR5c...",
     "registration_client_uri":"https://authorization-server.com/xxxxxxxxxx",
     "response_types":[],
     "token_endpoint_auth_method":"private_key_jwt"
     }
#### Client Credentials Flow
The Node can now request a bearer token from the Authentication Server using the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response). This access token will allow the Node to register itself with the NMOS Registry, and allow it....

_[Sequence Diagram]_

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

where client_assertion is a self signed JWT and client_id is the result from client registration.

Example token response:

	HTTP/1.1 200 OK
	Content-Type: application/json
	
	{
	 "access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
	 "expires_in":180,
	 "scope":"registration",
	 "token_type":"bearer"
	}

#### Refreshing the Bearer Token
The Bearer Token has a limited life specified by the value of the `expires_in` parameter in seconds.  The Node should refresh the token when it exceeds its half life (if the token life is 30 seconds, then it should be refreshed at least 15 seconds before token expiry (i.e. [half-life of the token](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime)). 
5. Node refreshes bearer token as in step 4 .



6. Node fetches [Authorization Server public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) in every hour for  validating incoming access token.

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
Example server public keys response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	[
	 {
	  "alg":"RS256",
	  "e":"AQAB",
	  "kid":"aRxkfaepyicuogJnoaXfUJAEDwiDQ3o914n2JNqToZ0",
	  "kty":"RSA",
	  "n":"jBRq3QfleVgYxjS3q-tmK8686Pc2HvR50kxfB6l...",
	  "use":"sig",
	  "x5c":["MIICmzCCAYMCBgFxiHgcuzANBgkqhkiG9w0BAQ..."],
	  "x5t":"qaEz9PpliodKhNXA5jqiUky5-RU",
	  "x5t#S256":"hfJS5jB9chso-iMQ7-QNAIXFPFwz6SjrohG81r6IxyE"
	 },
	 {
	  "alg":"ES256",
	  "crv":"P-256",
	  "kid":"jMRpEWZ8_-1pmdpGqEo4ZSCb7pltOVuoQQc46aYa7RM",
	  "kty":"EC",
	  "use":"sig",
	  "x":"e7DQRay3ZWCj-Y_-Ww-QN-m95KV2IBVpZ2raP3CF5XU",
	  "y":"ay2UR1ohsrWhJgsv8T0cV66yivD4kA9_3YV8RJFjD3k"
	 },
	 {
	  "alg":"RS512",
	  "e":"AQAB",
	  "kid":"O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
	  "kty":"RSA",
	  "n":"yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkmTYa...",
	  "use":"sig",
	  "x5c":["MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAw..."],
	  "x5t":"LD3awp-sYoVbcfwOgB9BRO4HFYQ",
	  "x5t#S256":"yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
	 }
	]

7. Node switches to next available Authorization Server, if it's unable to commuincate with the connected Authorization Server.
  
### Node to Registry (IS-04 Registration API)  
[ Include Sequence Diagram]
MF: I think the textual steps are:

1. Node is registered with the authorization server (flow diagram of steps?)  
2. Node sends client credentials (and other information?) to authorization server to get access token 
3. Node sends access token to registry as extra HTTP header with existing registry communications

Example resource registration request:

	POST /resource HTTP/1.1
    Host: registry.example.org
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...
    
    {
     "type": "node",
     "data": 
      description:"host1",
      hostname:"host1",
      label:"host1",
      ...
     }
    }

5. Does a description of the registry behaviour on receipt of the access token make sense here, or should that go elsewhere and have a link back to here? I believe it is essentially the same thing as stage 6 of the "controller to node" interaction below.  
6. If I understand correctly, the refresh token does not apply (or doesn't make much sense) in the client credentials grant workflow. So when the access token expires (checking IAT itself, or authorisation failure return from registry), the node just repeats step (2) 
  
### Controller to Node (IS-05, IS-08 and IS-04 Node API)  
[ Include Sequence Diagram]  

_MF: I believe the pattern for accessing all three of these APIs is very similar_

MF: I think the textual steps are:
1) Controller is registered with the authorisation server (does that apply, as I think it counts as a "public client"?)
2) Controller user gets redirected to authorisation server on login, to authenticate with authorisation server
3) Authorisation server returns redirect to client browser(?) as part of the authorisation code grant
4) Client (presumably part of the controller, not the user's browser) obtains access token from authorisation server for access to NMOS node resources (what extra information does it need to send?)
5) Controller sends access token to Node as part of HTTP headers on access to resources
6) Node has to verify the access token:
6a) Verify the signature of the token. This requires obtaining the public key from the authorisation server, and then applying a "RSASSA-PKCS1-v1_5 using SHA-512" check on the signature in the token
6b) Verify the fields of the token are correct, including expiry time, iat/nbf (IS-10 doesn't mention nbf, but other JWT texts do), aud and iss, plus x-nmos-* claims.
7) If stage 6 passes, then return the requested data, otherwise return an authorisation failure HTTP code.

_PB: as required, further guidance on spec details e.g. the NBF field question_  

### Event & Tally (IS-07)
[ Include Sequence Diagram]  
_MF: I believe the pattern for this API is different, as it can include node-to-node communication, and is mainly based around websockets or MQTT, rather than traditional HTTP requests_

## Development Resources 
### Authentication Server
[An auth server is required - link to open source implementations such as Keycloak]
_MF: Guidance on how to set it up for this. See AB wiki guide plus how to segment network. AB: maybe BBC could provide container with config, helped with docker-compose._  
  
### NMOS Testing Tool
[Description and links to the NMOS Testing tool]  
  
### VPN-based testing and virtual workshops
_[Question Only available to AMWA members, so probably best excluded from this guide?]_

_PB: yes, but could reference how we did this (TE blog post++)_
### JavaScript Web Token Tools
This [online tool](https://jwt.io/#debugger-io) is a useful webapp for experimenting with building and decoding JWTs.


## References
-   external OAuth 2.0 and JWT tutorials
-   Sony slides (updated)
-   not-as-yet-written IS-04/05/08 implementers' guides
-   Existing wiki implementers info
-   Initial white papers from BBC










<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJpeVREbld2VTN4ckFiQkoyIjp7In
RleHQiOiIxLiBOb2RlIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUg
YXV0aG9yaXphdGlvbiBzZXJ2ZXIgKGZsb3cgZGlhZ3JhbSBvZi
BzdGVwcz8p4oCmIiwic3RhcnQiOjEwODQ3LCJlbmQiOjExMDI3
fSwidXpLVWdzcGt6ZEJ2cThQSiI6eyJ0ZXh0IjoiMSkgQ29udH
JvbGxlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGF1dGhvcmlz
YXRpb24gc2VydmVyIChkb2VzIHRoYXQgYXBwbHksIGFz4oCmIi
wic3RhcnQiOjEyMjAyLCJlbmQiOjEyMzIxfSwiUkRqTXZ2bnNW
MU5FZTdOVSI6eyJ0ZXh0IjoiNS4gSWYgSSB1bmRlcnN0YW5kIG
NvcnJlY3RseSwgdGhlIHJlZnJlc2ggdG9rZW4gZG9lcyBub3Qg
YXBwbHkgKG9yIGRvZXNuJ3QgbWFrZeKApiIsInN0YXJ0IjoxMT
cyMywiZW5kIjoxMTk4OX0sIk5hbFh1ZGRzVkEwNE1ZUFAiOnsi
dGV4dCI6IkV2ZW50ICYgVGFsbHkgKElTLTA3KSIsInN0YXJ0Ij
oxMzQyMiwiZW5kIjoxMzQ0M30sImVQZ0dEQXQ4cHZBZG5lb2Yi
OnsidGV4dCI6IiMjIyMgW0lTLTA0IFJlZ2lzdHJhdGlvbiAmIE
Rpc2NvdmVyeV0oaHR0cHM6Ly9zcGVjcy5hbXdhLnR2L2lzLTA0
LykgJiBbSVMtMDUgQ2/igKYiLCJzdGFydCI6MTA2OSwiZW5kIj
oxMTY4fSwiaDFsMU5oSlpta0Vla2VaMiI6eyJzdGFydCI6MTA0
MCwiZW5kIjoxMDY4LCJ0ZXh0IjoiIyMjIE5NT1MgSVMtMDQsIE
lTLTA1LCBJUy0wOCJ9LCJITFZLT2FFVEtNMDNSNkZpIjp7InN0
YXJ0Ijo4MDUzLCJlbmQiOjgwNjksInRleHQiOiJhbmQgYWxsb3
cgaXQuLi4uIn19LCJjb21tZW50cyI6eyJkS0l5ZWdlZ29rZ2lQ
ZU9GIjp7ImRpc2N1c3Npb25JZCI6Iml5VERuV3ZVM3hyQWJCSj
IiLCJzdWIiOiJnaDozMDIzMTMyMSIsInRleHQiOiJkZXNjcmli
ZWQgaW4gc3RlcCAzIGFuZCA0IG9mIE5vZGUgdG8gQXV0aGVudG
ljYXRpb24gU2VydmVyIEludGVyYWN0aW9ucyIsImNyZWF0ZWQi
OjE2MTIzOTg1MjE0MDh9LCJrcDVRQ2F1RjRmd2JHWWJsIjp7Im
Rpc2N1c3Npb25JZCI6InV6S1Vnc3BremRCdnE4UEoiLCJzdWIi
OiJnaDozMDIzMTMyMSIsInRleHQiOiJtYXliZSB0aGlzIGJpdC
BzaG91bGQgYmUgZGVzY3JpYmVkIGluIGFub3RoZXIgZG9jICBD
b250cm9sbGVyIEltcGxlbWVuYXRlciBHdWlkZSBzZWN0aW9uIE
NvbnRyb2xsZXIgdG8gQXV0aGVudGljYXRpb24gU2VydmVyIElu
dGVyYWN0aW9ucyIsImNyZWF0ZWQiOjE2MTIzOTg4NTQ0NTl9LC
JraFFZcHNydWMzbEhtSEFMIjp7ImRpc2N1c3Npb25JZCI6IlJE
ak12dm5zVjFORWU3TlUiLCJzdWIiOiJnaDozMDIzMTMyMSIsIn
RleHQiOiJkZXNjcmliZWQgaW4gc3RlcCA1IG9mIE5vZGUgdG8g
QXV0aGVudGljYXRpb24gU2VydmVyIEludGVyYWN0aW9ucyIsIm
NyZWF0ZWQiOjE2MTIzOTg5MjYxNjh9LCJldFU4ZnlOOWNPS3dw
S21CIjp7ImRpc2N1c3Npb25JZCI6Ik5hbFh1ZGRzVkEwNE1ZUF
AiLCJzdWIiOiJnaDo2NDQxMDExOSIsInRleHQiOiJJcyB0aGlz
IGJleW9uZCB0aGUgc2NvcGUgb2YgdGhpcyBndWlkZT8iLCJjcm
VhdGVkIjoxNjEyNDU5NjMwMDY2fSwib1J1V3JOQWRWQmZqeEpM
SiI6eyJkaXNjdXNzaW9uSWQiOiJlUGdHREF0OHB2QWRuZW9mIi
wic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiTGlua2luZyB0
byByZXNvdXJjZXMgZnJvbSB0aXRsZSBbY29tcGFjdF0sIG9yIG
FzIGV4cGxpY2l0IGxpbmsgaW4gdGhlIHByb3NlIFt1c2VmdWwg
Zm9yIG11bHRpcGxlIHJlc291cmNlc10/IE9yIG1peGVkL2JvdG
g/IiwiY3JlYXRlZCI6MTYxMjUxODEyNTAwMH0sIkhJMkVLeUlE
MVJhR3lZN1EiOnsiZGlzY3Vzc2lvbklkIjoiaDFsMU5oSlpta0
Vla2VaMiIsInN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6IklT
LTA3Pz8/Pz8iLCJjcmVhdGVkIjoxNjEyNTM3NTQzOTgyfSwieH
lSVVZtc0ZETndEampseSI6eyJkaXNjdXNzaW9uSWQiOiJITFZL
T2FFVEtNMDNSNkZpIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZX
h0IjoiTmVlZCB3b3JkcyBmb3IgdmFsaWRhdGluZyBpbnRlcmFj
dGlvbnMgd2l0aCB0aGUgdG9rZW4iLCJjcmVhdGVkIjoxNjEyNT
M4MjEyMDcxfX0sImhpc3RvcnkiOlsyMDc1OTc5NjE3LDExNDM2
ODgzNDgsLTEwNDczNzUxNjcsLTExNjk1MjE0MTYsNDY1MzcxNz
k5LC01OTg2Mzk2MTksMTQ2MTQ1MzczMCwxNDM5NzU2NTE2LDE4
NzgxNTUwMTMsLTg0Mzc5NzQyNCwtMTUwNjQ2Mzg4MSwtNzg4OT
k0NDEsLTE4NTk1OTk1MTEsLTUxNDY5OTc1NiwtODM3MjE4ODUw
LDEyNTM3ODUzMywxODg1NTQwOTI3LC0xNjM2NTI5NzcyLDM3MT
MwMDQzOSwxNjY5MzgzNDkzXX0=
-->