# NMOS Authorization: Node  Implementation Guide
_(c) AMWA 2020, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_

## Document Overview
### Scope
This document is intended as a guide for implementers who want to add NMOS Authorization to their NMOS Nodes, where that Node is a typical broadcast device. (Implementation of NMOS Authorization in Nodes that act as controllers is NOT within the scope of this document [REF to NMOS Controller guide]).
### Structure

 - _Pre-requisites_ - what you need to know before you start your implementation.
 - _Authenticated API Calls_ - including NMOS Authorization in your Node implementation.
 - _Development Resources_ - useful tools and resources to help in your   
   implementation journey. 
- _References_ - In addition to the links to   
   articles, specifications and tutorials found within the guide, this  
   section contains other useful reading.
 
## Pre-requisites
Before using this guide, you should be familiar with the following specification and technologies.
  
### NMOS IS-04, IS-05, IS-08
#### [IS-04 Registration & Discovery](https://specs.amwa.tv/is-04/) & [IS-05 Connection Management](https://specs.amwa.tv/is-05/)
As well as a familiarity with the standards, it is also assumed that you already have a working implementation of IS-04 and IS-05 for your NMOS Node.
#### [IS-08 Audio Channel Mapping](https://specs.amwa.tv/is-08/)
If your device has audio capability, then as well as being familiar with the standard, it is assumed that you already have a working implementation of IS-08 for your NMOS Node.
#### [IS-10 Authorization](https://specs.amwa.tv/is-10/) 
The IS-10 Authorization specification is based on OAuth2 and is used for controlling access to IS-04, IS-05 and IS-08 APIs.  This guide will detail implementation of IS-10 in NMOS nodes (excluding controller nodes) for IS-04, IS-05 and IS-08 API calls.
  
### OAuth 2.0
Given that IS-10 is based on OAuth 2.0, a familiarity with the way OAuth 2.0 authorization works, and in particular the Client Credentials Grant flow, is required.  The authorization flows used by IS-10 are the Client Credentials Grant and the Authentication Code Flow. The latter is implemented when the NMOS node is a controller.

The following set of articles give a good grounding in OAuth 2.0.  They are from a four part series; the first three give a good grounding in OAuth 2.0 and JWT independent of implementation language. The fourth article is specific to Java implementations.
[Deep Dive Into OAuth2.0 and JWT (Part 1 Setting the Stage)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st "https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-1-setting-the-st")
[Deep Dive Into OAuth2.0 and JWT (Part 2 OAuth2.0)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-2-oauth20)
[Deep Dive to OAuth2.0 and JWT (Part 3)](https://dzone.com/articles/deep-dive-to-oauth20-amp-jwt-part-3-jwt)
[Deep Dive to OAuth2.0 and JWT (Part 4 JWT Use Case)](https://dzone.com/articles/what-is-zuul)

### JavaScript Web Tokens (JWT)
JavaScript Web Tokens is the preferred type of token used in IS-10.  A familiarity with JWT can be gained from the articles linked in the OAuth 2.0 section, or from this [introduction to JWT](https://jwt.io/introduction). 
  
## Implementing Authenticated API Calls

### Node to Authorization Server Interactions  
#### Discovery of the Authorization Server
In order to interact with the Authorization Server, you need to know where it is.  IS-10 specifies that Node the [Authorization Server should use unicast DNS-SD](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#dns-sd-advertisemen) to advertise itself to the  Node.

Once the node knows the whereabouts of the Authorization Server it can then fetch the [Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

_[Authorization server discovery sequence diagram??????]_

Example request to get server metadata:

    GET /.well-known/oauth-authorization-server HTTP/1.1
    Host: authorization-server.com

Example server metadata response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	{
	  "issuer": "https://authorization-server.com",
	  "authorization_endpoint": "authorization-server.com/authorize",
	  "token_endpoint": "https://authorization-server.com/token",
	  "token_introspection_endpoint": "https://authorization-server.com/introspect",
	  "userinfo_endpoint": "https://authorization-server.com/userinfo",
	  "end_session_endpoint": "https://authorization-server.com/logout",
	  "jwks_uri": "https://authorization-server.com/jwks",	  
	  "grant_types_supported": [
	    "authorization_code",
	    "implicit",
	    "refresh_token",
	    "password",
	    "client_credentials"
	  ],
	  "response_types_supported": [
	    "code",
	    "none",
	    "id_token",
	    "token",
	    "id_token token",
	    "code id_token",
	    "code token",
	    "code id_token token"
	  ],
	  "id_token_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "registration_endpoint": "https://authorization-server.com/register",
	  "token_endpoint_auth_methods_supported": [
	    "private_key_jwt",
	    "client_secret_basic",
	    "client_secret_post",
	    "tls_client_auth",
	    "client_secret_jwt"
	  ],
	  "token_endpoint_auth_signing_alg_values_supported": [
	    "PS384",
	    "ES384",
	    "RS384",
	    "HS256",
	    "HS512",
	    "ES256",
	    "RS256",
	    "HS384",
	    "ES512",
	    "PS256",
	    "PS512",
	    "RS512"
	  ],
	  "scopes_supported": [
	    "openid",
	    "connection",
	    "node",
	    "query",
	    "registration"
	  ],
	  "code_challenge_methods_supported": [
	    "plain",
	    "S256"
	  ]
	}

#### Client Registration 
NMOS nodes needs to first register themselves with the Authorization Server.  This is usually a one time operation that a Node would typically perform when first activated on the network.

The registration is done via a [dynamic client registration](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-registration) with the Authorization Server. The registration includes the expected grant type, which should be set to  [client crendentials grant](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.2._Behaviour_-_Clients.html#client-credentials)

![Client Registration](./images/client_registration.png)

Example client registration request including initial access token:

    POST /register HTTP/1.1
    Host: authorization-server.com
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCIg...
    
	{
	 "client_name": "My Example Client",
	 "grant_types": ["client_credentials"],
	 "jwks_uri": "https://client.example.org/my_public_keys.jwks",
	 "response_types": ["none"],
	 "scope": "registration",
	 "token_endpoint_auth_method": "private_key_jwt"
	}

Example response:

    HTTP/1.1 201 Created
    Content-Type: application/json
    	
    {
     "client_id": "xxxxxxxxxx",
     "client_name":"My Example Client",
     "client_id_issued_at": 1611940142,
     "grant_types":["client_credentials"],
     "jwks_uri":"https://client.example.org/my_public_keys.jwks",
     "redirect_uris":[],
     "registration_access_token":"eyJhbGciOiJIUzI1NiIsInR5c...",
     "registration_client_uri":"https://authorization-server.com/xxxxxxxxxx",
     "response_types":[],
     "token_endpoint_auth_method":"private_key_jwt"
     }
#### Client Credentials Flow
The Node can now request a bearer token from the Authorization Server using the [client credentials flow](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.3._Behaviour_-_Token_Requests.html#access-token-request-and-response). This access token will allow the Node to register itself with the NMOS Registry, and allow it....

_[Sequence Diagram]_

Example request to get bearer token:

	POST /token HTTP/1.1
	Host: authorization-server.com
    Content-Type: application/x-www-form-urlencoded
    
    grant_type=client_credentials
    &client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
    &client_assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.ey...
    &client_id=xxxxxxxxxx
    &scope=registration

where client_assertion is a self signed JWT and client_id is the result from client registration.

Example token response:

	HTTP/1.1 200 OK
	Content-Type: application/json
	
	{
	 "access_token":"eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...",
	 "expires_in":180,
	 "scope":"registration",
	 "token_type":"bearer"
	}

#### Refreshing the Bearer Token
The Bearer Token has a limited life specified by the value of the `expires_in` parameter in seconds.  The Node should refresh the token when it exceeds its half life (if the token life is 30 seconds, then it should be refreshed at least 15 seconds before token expiry (i.e. [half-life of the token](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.4._Behaviour_-_Access_Tokens.html#access-token-lifetime)). 

Example:??????

#### Fetch Authorization Server Public Keys
As well as acquiring a token to allow this Node to register, the Node will also need the [Authorization Server's public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) so that it can calls on its own APIs.  These keys should be fetched every hour to ensure the keys are always up to date.

_[Sequence Diagram]_

Example request to get server public keys:

	GET /jwks HTTP/1.1
    Host: authorization-server.com
    
Example server public keys response:

	HTTP/1.1 200 OK
	Content-Type: application/json

	[
	 {
	  "alg":"RS256",
	  "e":"AQAB",
	  "kid":"aRxkfaepyicuogJnoaXfUJAEDwiDQ3o914n2JNqToZ0",
	  "kty":"RSA",
	  "n":"jBRq3QfleVgYxjS3q-tmK8686Pc2HvR50kxfB6l...",
	  "use":"sig",
	  "x5c":["MIICmzCCAYMCBgFxiHgcuzANBgkqhkiG9w0BAQ..."],
	  "x5t":"qaEz9PpliodKhNXA5jqiUky5-RU",
	  "x5t#S256":"hfJS5jB9chso-iMQ7-QNAIXFPFwz6SjrohG81r6IxyE"
	 },
	 {
	  "alg":"ES256",
	  "crv":"P-256",
	  "kid":"jMRpEWZ8_-1pmdpGqEo4ZSCb7pltOVuoQQc46aYa7RM",
	  "kty":"EC",
	  "use":"sig",
	  "x":"e7DQRay3ZWCj-Y_-Ww-QN-m95KV2IBVpZ2raP3CF5XU",
	  "y":"ay2UR1ohsrWhJgsv8T0cV66yivD4kA9_3YV8RJFjD3k"
	 },
	 {
	  "alg":"RS512",
	  "e":"AQAB",
	  "kid":"O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
	  "kty":"RSA",
	  "n":"yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkmTYa...",
	  "use":"sig",
	  "x5c":["MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQELBQAw..."],
	  "x5t":"LD3awp-sYoVbcfwOgB9BRO4HFYQ",
	  "x5t#S256":"yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
	 }
	]

Note that if a Node is unable to contact an Authorization Server, it should attempt to contact another Authorization Server from the discovered list until this [either succeeds or the list is exhausted](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys). 
  
### Node to Registry Interactions (IS-04 Registration API)  
Once the Node has registered with the Authorization Server, and acquired a Bearer Token, the next step is for it to register with the NMOS Registry using the IS-04 API.

The API call should include the Bearer Token 

MF: I think the textual steps are:

1. Node is registered with the authorization server (flow diagram of steps?)  
2. Node sends client credentials (and other information?) to authorization server to get access token 
3. Node sends access token to registry as extra HTTP header with existing registry communications

_[ Include Sequence Diagram]_

Example resource registration request:

	POST /resource HTTP/1.1
    Host: registry.example.org
    Content-Type: application/json
    Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSl...
    
    {
     "type": "node",
     "data": 
      description:"host1",
      hostname:"host1",
      label:"host1",
      ...
     }
    }

5. Does a description of the registry behaviour on receipt of the access token make sense here, or should that go elsewhere and have a link back to here? I believe it is essentially the same thing as stage 6 of the "controller to node" interaction below.  
6. If I understand correctly, the refresh token does not apply (or doesn't make much sense) in the client credentials grant workflow. So when the access token expires (checking IAT itself, or authorisation failure return from registry), the node just repeats step (2) 
  
### Controller to Node (IS-05, IS-08 and IS-04 Node API)  
[ Include Sequence Diagram]  

_MF: I believe the pattern for accessing all three of these APIs is very similar_

MF: I think the textual steps are:
1) Controller is registered with the authorisation server (does that apply, as I think it counts as a "public client"?)
2) Controller user gets redirected to authorisation server on login, to authenticate with authorisation server
3) Authorisation server returns redirect to client browser(?) as part of the authorisation code grant
4) Client (presumably part of the controller, not the user's browser) obtains access token from authorisation server for access to NMOS node resources (what extra information does it need to send?)
5) Controller sends access token to Node as part of HTTP headers on access to resources
6) Node has to verify the access token:
6a) Verify the signature of the token. This requires obtaining the public key from the authorisation server, and then applying a "RSASSA-PKCS1-v1_5 using SHA-512" check on the signature in the token
6b) Verify the fields of the token are correct, including expiry time, iat/nbf (IS-10 doesn't mention nbf, but other JWT texts do), aud and iss, plus x-nmos-* claims.
7) If stage 6 passes, then return the requested data, otherwise return an authorisation failure HTTP code.

_PB: as required, further guidance on spec details e.g. the NBF field question_  

### Event & Tally (IS-07)
[ Include Sequence Diagram]  
_MF: I believe the pattern for this API is different, as it can include node-to-node communication, and is mainly based around websockets or MQTT, rather than traditional HTTP requests_

## Development Resources 
### Authorization Server
[An auth server is required - link to open source implementations such as Keycloak]
_MF: Guidance on how to set it up for this. See AB wiki guide plus how to segment network. AB: maybe BBC could provide container with config, helped with docker-compose._  
  
### NMOS Testing Tool
[Description and links to the NMOS Testing tool]  
  
### VPN-based testing and virtual workshops
_[Question Only available to AMWA members, so probably best excluded from this guide?]_

_PB: yes, but could reference how we did this (TE blog post++)_
### JavaScript Web Token Tools
This [online tool](https://jwt.io/#debugger-io) is a useful webapp for experimenting with building and decoding JWTs.


## References
-   external OAuth 2.0 and JWT tutorials
-   Sony slides (updated)
-   not-as-yet-written IS-04/05/08 implementers' guides
-   Existing wiki implementers info
-   Initial white papers from BBC










<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJpeVREbld2VTN4ckFiQkoyIjp7In
RleHQiOiIxLiBOb2RlIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUg
YXV0aG9yaXphdGlvbiBzZXJ2ZXIgKGZsb3cgZGlhZ3JhbSBvZi
BzdGVwcz8p4oCmIiwic3RhcnQiOjExMzg1LCJlbmQiOjExNTY1
fSwidXpLVWdzcGt6ZEJ2cThQSiI6eyJ0ZXh0IjoiMSkgQ29udH
JvbGxlciBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGF1dGhvcmlz
YXRpb24gc2VydmVyIChkb2VzIHRoYXQgYXBwbHksIGFz4oCmIi
wic3RhcnQiOjEyNzcxLCJlbmQiOjEyODkwfSwiUkRqTXZ2bnNW
MU5FZTdOVSI6eyJ0ZXh0IjoiNS4gSWYgSSB1bmRlcnN0YW5kIG
NvcnJlY3RseSwgdGhlIHJlZnJlc2ggdG9rZW4gZG9lcyBub3Qg
YXBwbHkgKG9yIGRvZXNuJ3QgbWFrZeKApiIsInN0YXJ0IjoxMj
I5MiwiZW5kIjoxMjU1OH0sIk5hbFh1ZGRzVkEwNE1ZUFAiOnsi
dGV4dCI6IkV2ZW50ICYgVGFsbHkgKElTLTA3KSIsInN0YXJ0Ij
oxMzk5MSwiZW5kIjoxNDAxMn0sImVQZ0dEQXQ4cHZBZG5lb2Yi
OnsidGV4dCI6IiMjIyMgW0lTLTA0IFJlZ2lzdHJhdGlvbiAmIE
Rpc2NvdmVyeV0oaHR0cHM6Ly9zcGVjcy5hbXdhLnR2L2lzLTA0
LykgJiBbSVMtMDUgQ2/igKYiLCJzdGFydCI6MTA2NSwiZW5kIj
oxMTY0fSwiaDFsMU5oSlpta0Vla2VaMiI6eyJzdGFydCI6MTAz
NiwiZW5kIjoxMDY0LCJ0ZXh0IjoiIyMjIE5NT1MgSVMtMDQsIE
lTLTA1LCBJUy0wOCJ9LCJITFZLT2FFVEtNMDNSNkZpIjp7InN0
YXJ0Ijo4MDMyLCJlbmQiOjgwNDgsInRleHQiOiJhbmQgYWxsb3
cgaXQuLi4uIn0sIkg1dUJXNDRham9GeWoyOHYiOnsic3RhcnQi
OjkyMDksImVuZCI6OTIyMywidGV4dCI6IkV4YW1wbGU6Pz8/Pz
8/In19LCJjb21tZW50cyI6eyJkS0l5ZWdlZ29rZ2lQZU9GIjp7
ImRpc2N1c3Npb25JZCI6Iml5VERuV3ZVM3hyQWJCSjIiLCJzdW
IiOiJnaDozMDIzMTMyMSIsInRleHQiOiJkZXNjcmliZWQgaW4g
c3RlcCAzIGFuZCA0IG9mIE5vZGUgdG8gQXV0aGVudGljYXRpb2
4gU2VydmVyIEludGVyYWN0aW9ucyIsImNyZWF0ZWQiOjE2MTIz
OTg1MjE0MDh9LCJrcDVRQ2F1RjRmd2JHWWJsIjp7ImRpc2N1c3
Npb25JZCI6InV6S1Vnc3BremRCdnE4UEoiLCJzdWIiOiJnaDoz
MDIzMTMyMSIsInRleHQiOiJtYXliZSB0aGlzIGJpdCBzaG91bG
QgYmUgZGVzY3JpYmVkIGluIGFub3RoZXIgZG9jICBDb250cm9s
bGVyIEltcGxlbWVuYXRlciBHdWlkZSBzZWN0aW9uIENvbnRyb2
xsZXIgdG8gQXV0aGVudGljYXRpb24gU2VydmVyIEludGVyYWN0
aW9ucyIsImNyZWF0ZWQiOjE2MTIzOTg4NTQ0NTl9LCJraFFZcH
NydWMzbEhtSEFMIjp7ImRpc2N1c3Npb25JZCI6IlJEak12dm5z
VjFORWU3TlUiLCJzdWIiOiJnaDozMDIzMTMyMSIsInRleHQiOi
JkZXNjcmliZWQgaW4gc3RlcCA1IG9mIE5vZGUgdG8gQXV0aGVu
dGljYXRpb24gU2VydmVyIEludGVyYWN0aW9ucyIsImNyZWF0ZW
QiOjE2MTIzOTg5MjYxNjh9LCJldFU4ZnlOOWNPS3dwS21CIjp7
ImRpc2N1c3Npb25JZCI6Ik5hbFh1ZGRzVkEwNE1ZUFAiLCJzdW
IiOiJnaDo2NDQxMDExOSIsInRleHQiOiJJcyB0aGlzIGJleW9u
ZCB0aGUgc2NvcGUgb2YgdGhpcyBndWlkZT8iLCJjcmVhdGVkIj
oxNjEyNDU5NjMwMDY2fSwib1J1V3JOQWRWQmZqeEpMSiI6eyJk
aXNjdXNzaW9uSWQiOiJlUGdHREF0OHB2QWRuZW9mIiwic3ViIj
oiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiTGlua2luZyB0byByZXNv
dXJjZXMgZnJvbSB0aXRsZSBbY29tcGFjdF0sIG9yIGFzIGV4cG
xpY2l0IGxpbmsgaW4gdGhlIHByb3NlIFt1c2VmdWwgZm9yIG11
bHRpcGxlIHJlc291cmNlc10/IE9yIG1peGVkL2JvdGg/IiwiY3
JlYXRlZCI6MTYxMjUxODEyNTAwMH0sIkhJMkVLeUlEMVJhR3lZ
N1EiOnsiZGlzY3Vzc2lvbklkIjoiaDFsMU5oSlpta0Vla2VaMi
IsInN1YiI6ImdoOjY0NDEwMTE5IiwidGV4dCI6IklTLTA3Pz8/
Pz8iLCJjcmVhdGVkIjoxNjEyNTM3NTQzOTgyfSwieHlSVVZtc0
ZETndEampseSI6eyJkaXNjdXNzaW9uSWQiOiJITFZLT2FFVEtN
MDNSNkZpIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiTm
VlZCB3b3JkcyBmb3IgdmFsaWRhdGluZyBpbnRlcmFjdGlvbnMg
d2l0aCB0aGUgdG9rZW4iLCJjcmVhdGVkIjoxNjEyNTM4MjEyMD
cxfSwieG4yWUF4djlJalM4a3ZIMyI6eyJkaXNjdXNzaW9uSWQi
OiJINXVCVzQ0YWpvRnlqMjh2Iiwic3ViIjoiZ2g6NjQ0MTAxMT
kiLCJ0ZXh0IjoiSXQgbWlnaHQgYmUgcmVwZXRpdGlvbiwgYnV0
IHNob3VsZCB3ZSBpbmNsdWRlIGV4YW1wbGUgaGVyZT8iLCJjcm
VhdGVkIjoxNjEyNTM4OTE1OTUyfX0sImhpc3RvcnkiOlszMzAy
OTM2MywxMTQzNjg4MzQ4LC0xMDQ3Mzc1MTY3LC0xMTY5NTIxND
E2LDQ2NTM3MTc5OSwtNTk4NjM5NjE5LDE0NjE0NTM3MzAsMTQz
OTc1NjUxNiwxODc4MTU1MDEzLC04NDM3OTc0MjQsLTE1MDY0Nj
M4ODEsLTc4ODk5NDQxLC0xODU5NTk5NTExLC01MTQ2OTk3NTYs
LTgzNzIxODg1MCwxMjUzNzg1MzMsMTg4NTU0MDkyNywtMTYzNj
UyOTc3MiwzNzEzMDA0MzksMTY2OTM4MzQ5M119
-->