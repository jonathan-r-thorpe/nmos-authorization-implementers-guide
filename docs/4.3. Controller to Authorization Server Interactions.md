
# Controller to Authorization Server Interactions  
_(c) AMWA 2021, CC Attribution-NoDerivatives 4.0 International (CC BY-ND 4.0)_
## Overview
This section details the interactions between an NMOS Node acting as a controller and the Authorization Server. These include:

 - **Discovery of the Authorization Server**
 - **Client Registration**: Registration of the NMOS Node with the Authorization Server.
 - **Authentication Code Flow**: Request of an Access Token from the Authorization Server.
 - **Refreshing the Bearer Token**: Ensuring the token is always valid 
- **Fetch Authorization Server Public Keys**: To authenticate Access Tokens in incoming API calls.

[Sequence Diagram]

The sequence diagram above gives an overview of these interaction which are described in more detail below.
## Discovery of the Authorization Server
In order to interact with the Authorization Server, you need to know where it is.  IS-10 specifies that the [Authorization Server should use unicast DNS-SD](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#dns-sd-advertisemen) to advertise itself to the  Node.

Once the node knows the whereabouts of the Authorization Server it can then fetch the [Authorization Server Metadata](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/3.0._Discovery.html#authorization-server-metadata-endpoint) to obtain supported features and endpoints.

Example request to get server metadata:

```
GET /.well-known/oauth-authorization-server HTTP/1.1
Host: authorization-server.example.com
```
Example server metadata HTTP response:
```
HTTP/1.1 200 OK
Content-Type: application/json
```
```
{
  "authorization_endpoint": "https://authorization-server.example.com/authorize",
  "code_challenge_methods_supported": [
    "plain",
    "S256"
  ],
  "grant_types_supported": [
    "authorization_code",
    "implicit",
    "refresh_token",
    "password",
    "client_credentials"
  ],
  "issuer": "https://authorization-server.example.com",
  "jwks_uri": "https://authorization-server.example.com/jwks",
  "registration_endpoint": "https://authorization-server.example.com/register",
  "request_object_signing_alg_values_supported": [
    "PS384",
    "ES384",
    "RS384",
    "HS256",
    "HS512",
    "ES256",
    "RS256",
    "HS384",
    "ES512",
    "PS256",
    "PS512",
    "RS512",
    "none"
  ],
  "response_types_supported": [
    "code",
    "none",
    "token",
    "code token"
  ],
  "scopes_supported": [
    "channelmapping",
    "connection",
    "events",
    "node",
    "query",
    "registration"
  ],
  "token_endpoint": "https://authorization-server.example.com/token",
  "token_endpoint_auth_methods_supported": [
    "private_key_jwt",
    "client_secret_basic",
    "client_secret_post",
    "tls_client_auth",
    "client_secret_jwt"
  ],
  "token_endpoint_auth_signing_alg_values_supported": [
    "PS384",
    "ES384",
    "RS384",
    "HS256",
    "HS512",
    "ES256",
    "RS256",
    "HS384",
    "ES512",
    "PS256",
    "PS512",
    "RS512"
  ]
}
```
## Client Registration 
NMOS nodes first needs to register with the Authorization Server.  This is usually a one time operation that a Node would typically perform when first activated on the network.

## Authentication Code Flow
[Some words]

## Refreshing the Bearer Token
The Bearer Token has a limited life 

## Fetch Authorization Server Public Keys
As well as acquiring a token to allow this Node to register, the Node will also need the [Authorization Server's public keys](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys) so that it can authenticate calls on its own APIs.  These keys should be fetched every hour to ensure the keys are always up to date.

Example request to get server public keys:
```
GET /jwks HTTP/1.1
Host: authorization-server.example.com
```
Example server public keys response:
```
HTTP/1.1 200 OK
Content-Type: application/json
```
```
[
  {
    "alg": "RS512",
    "e": "AQAB",
    "kid": "O4QEicS70s1DWFyt84niI80Z2SLsdNrVyeGwJe8g8qw",
    "kty": "RSA",
    "n": "yeSbbHw18xN3hh_VeHpSI01Fcp0xaI1znmWBVkm...",
    "use": "sig",
    "x5c": [
      "MIIFlTCCA32gAwIBAgICEAAwDQYJKoZIhvcNAQ..."
    ],
    "x5t": "LD3awp-sYoVbcfwOgB9BRO4HFYQ",
    "x5t#S256": "yCrclAKahB6SE68rbx5cRwuBZoeTXfW9smoLgt6u9t4"
  }
]
```
Note that if a Node is unable to contact an Authorization Server, it should attempt to contact another Authorization Server from the discovered list until this [either succeeds or the list is exhausted](https://specs.amwa.tv/is-10/branches/v1.0-dev/docs/4.5._Behaviour_-_Resource_Servers.html#public-keys). 
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE2MDAyNDY5MTMsNDUxMzY4MDgxLDE1MD
MzMzQ3MjBdfQ==
-->